<!DOCTYPE HTML>
<html><head><meta charset="UTF-8"><style type="text/css">/* Copyright 2019 Google LLC                              */
/*                                                        */
/* Use of this source code is governed by a BSD-style     */
/* license that can be found in the LICENSE file or at    */
/* https://developers.google.com/open-source/licenses/bsd */

body {
  font-family: Helvetica, sans-serif;
  font-size: 100%;
  color: #333;
  display: flex;
  justify-content: space-between;
  overflow-x: hidden;

  --main-width: 50rem;
  --nav-width: 20rem;
}

@media (max-width: 70rem) {
    /*For narrow screens hide nav and enable horizontal scrolling */
    nav {display: none;}
    body {overflow-x: auto;}
}

nav {/* this actually just holds space for #navbar, which is fixed */
  min-width: var(--nav-width);
  max-width: var(--nav-width);
}
#navbar {
  position: fixed;
  height: 100vh;
  width: var(--nav-width);
  overflow-y: scroll;
  border-right: 1px solid firebrick;
}
#navbar:before {
  content: "Contents";
  font-weight: bold;
}
nav ol {
  list-style-type:none;
  padding-left: 1rem;
}

#main-output {
  max-width: var(--main-width);
  margin: auto;
}

.cell {
}

.code-block, .err-block, .result-block {
  padding: 0em 0em 0em 2em;
  display: block;
  font-family: monospace;
  white-space: pre;
}

code {
  background-color: #F0F0F0;
}

.result-block {
  border-left: 3px solid  #87CEFA;
}

.prose-block {
  line-height: 140%;
}

.err-block {
  font-weight: bold;
  color: #B22222;
  border-left: 3px solid #B22222;
}

.plot {
  padding: 5em;
}

.plot-img {
  width: 80%;
}

.comment {
  color: #808080;
}

.keyword {
  color: #0000DD;
}

.command {
  color: #A80000;
}

.symbol {
  color: #E07000;
}

.type-name {
  color: #A80000;
}

.iso-sugar {
  color: #25BBA7;
}
</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"></script><script defer="" src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" onload="// Copyright 2019 Google LLC
//
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file or at
// https://developers.google.com/open-source/licenses/bsd

var katexOptions = {
    delimiters: [
        {left: &quot;$$&quot;, right: &quot;$$&quot;, display: true},
        {left: &quot;\\[&quot;, right: &quot;\\]&quot;, display: true},
        {left: &quot;$&quot;, right: &quot;$&quot;, display: false},
        {left: &quot;\\(&quot;, right: &quot;\\)&quot;, display: false}
    ],
    // Enable commands that load resources or change HTML attributes
    // (e.g. hyperlinks): https://katex.org/docs/security.html.
    trust: true
};

var cells = {};

function append_contents(key, contents) {
    if (key in cells) {
        var cur_cells = cells[key];
    } else {
        var cell = document.createElement(&quot;div&quot;);
        cell.className = &quot;cell&quot;;
        cells[key] = [cell];
        var cur_cells = [cell];
    }
    for (var i = 0; i &lt; contents.length; i++) {
        for (var j = 0; j &lt; cur_cells.length; j++) {
            var node = lookup_address(cur_cells[j], contents[i][0])
            node.innerHTML += contents[i][1];
        }
    }
}

function lookup_address(cell, address) {
    var node = cell
    for (i = 0; i &lt; address.length; i++) {
        node = node.children[address[i]]
    }
    return node
}

function renderLaTeX() {
    // Render LaTeX equations in prose blocks via KaTeX.
    var proseBlocks = document.querySelectorAll(&quot;.prose-block&quot;);
    Array.from(proseBlocks).map((proseBlock) =&gt;
        renderMathInElement(proseBlock, katexOptions)
    );
}

/**
 * Rendering the Table of Contents / Navigation Bar
 * 2 key functions
 *  - `updateNavigation()` which inserts/updates the navigation bar
 *  - and it&#39;s helper `extractStructure()` which extracts the structure of the page
 *    and adds ids to heading elements.
*/
function updateNavigation() {
    function navItemList(struct) {
        var listEle = document.createElement(&#39;ol&#39;)
        struct.children.forEach(childStruct=&gt;
            listEle.appendChild(navItem(childStruct))
        );
        return listEle;
    }
    function navItem(struct) {
        var a = document.createElement(&#39;a&#39;);
        a.appendChild(document.createTextNode(struct.text));
        a.title = struct.text;
        a.href = &quot;#&quot;+struct.id;

        var ele = document.createElement(&#39;li&#39;)
        ele.appendChild(a)
        ele.appendChild(navItemList(struct));
        return ele;
    }

    var navbarEle = document.getElementById(&quot;navbar&quot;)
    if (navbarEle === null) {  // create it
        navbarEle = document.createElement(&quot;div&quot;);
        navbarEle.id=&quot;navbar&quot;;
        navOuterEle = document.createElement(&quot;nav&quot;)
        navOuterEle.appendChild(navbarEle);
        document.body.prepend(navOuterEle);
    }

    navbarEle.innerHTML = &quot;&quot;
    var structure = extractStructure()
    navbarEle.appendChild(navItemList(structure));
}

function extractStructure() { // Also sets ids on h1,h2,...
    var headingsNodes = document.querySelectorAll(&quot;h1, h2, h3, h4, h5, h6&quot;);
    // For now we are just fulling going to regenerate the structure each time
    // Might be better if we made minimal changes, but ð¤·

    // Extract the structure of the document
    var structure = {children:[]}
    var active = [structure.children];
    headingsNodes.forEach(
        function(currentValue, currentIndex) {
            currentValue.id = &quot;s-&quot; + currentIndex;
            var currentLevel = parseInt(currentValue.nodeName[1]);

            // Insert dummy levels up for any levels that are skipped
            for (var i=active.length; i &lt; currentLevel; i++) {
                var dummy = {id: &quot;&quot;, text: &quot;&quot;, children: []}
                active.push(dummy.children);
                var parentList = active[i-1]
                parentList.push(dummy);
            }
            // delete this level and everything after
            active.splice(currentLevel, active.length);

            var currentStructure = {
                id: currentValue.id,
                text: currentValue.textContent,
                children: [],
            };
            active.push(currentStructure.children);

            var parentList = active[active.length-2]
            parentList.push(currentStructure);
        },
    );
    return structure;
}

/**
 * HTML rendering mode.
 * Static rendering is used for static HTML pages.
 * Dynamic rendering is used for dynamic HTML pages via `dex web`.
 *
 * @enum {string}
 */
var RENDER_MODE = Object.freeze({
  STATIC: &quot;static&quot;,
  DYNAMIC: &quot;dynamic&quot;,
})

/**
 * Renders the webpage.
 * @param {RENDER_MODE} renderMode The render mode, either static or dynamic.
 */
function render(renderMode) {
    if (renderMode == RENDER_MODE.STATIC) {
        // For static pages, simply call rendering functions once.
        renderLaTeX();
        updateNavigation();
    } else {
        // For dynamic pages (via `dex web`), listen to update events.
        var source = new EventSource(&quot;/getnext&quot;);
        source.onmessage = function(event) {
            var body = document.getElementById(&quot;main-output&quot;);
            var msg = JSON.parse(event.data);
            if (msg == &quot;start&quot;) {
                body.innerHTML = &quot;&quot;;
                cells = {}
                return
            }
            var order    = msg[0];
            var contents = msg[1];
            for (var i = 0; i &lt; contents.length; i++) {
                append_contents(contents[i][0], contents[i][1]);
            }
            if (order != null) {
                var new_cells = {};
                body.innerHTML = &quot;&quot;;
                for (var i = 0; i &lt; order.val.length; i++) {
                    var key = order.val[i]
                    var cur_cells = cells[key]
                    if (cur_cells.length == 0) {
                        var cur_cell = new_cells[key][0].cloneNode(true)
                    } else {
                        var cur_cell = cur_cells.pop()
                        if (key in new_cells) {
                            new_cells[key].push(cur_cell);
                        } else {
                            new_cells[key] = [cur_cell];
                        }
                    }
                    body.appendChild(cur_cell);
                }
                Object.assign(cells, new_cells);
            }
            renderLaTeX();
            updateNavigation();
        };
    }
}
render(RENDER_MODE.STATIC);"></script></head><body><div id="main-output"><div class="cell"><div class="prose-block"><h1>Dex prelude</h1>
</div></div><div class="cell"><div class="prose-block"><p>Runs before every Dex program unless an alternative is provided with <code>--prelude</code>.</p>
</div></div><div class="cell"><div class="prose-block"><h2>Essentials</h2>
<h3>Primitive Types</h3>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Unit</span> <span class="symbol">=</span> %<span class="type-name">UnitType</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">TyKind</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Effects</span> <span class="symbol">=</span> %<span class="type-name">EffKind</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Fields</span> <span class="symbol">=</span> %<span class="type-name">LabeledRowKind</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int64</span> <span class="symbol">=</span> %<span class="type-name">Int64</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int32</span> <span class="symbol">=</span> %<span class="type-name">Int32</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Float64</span> <span class="symbol">=</span> %<span class="type-name">Float64</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Float32</span> <span class="symbol">=</span> %<span class="type-name">Float32</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Word8</span>  <span class="symbol">=</span> %<span class="type-name">Word8</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Word32</span> <span class="symbol">=</span> %<span class="type-name">Word32</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Word64</span> <span class="symbol">=</span> %<span class="type-name">Word64</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Byte</span> <span class="symbol">=</span> <span class="type-name">Word8</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Char</span> <span class="symbol">=</span> <span class="type-name">Byte</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">RawPtr</span> <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">Word8Ptr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="type-name">Int</span> <span class="symbol">=</span> <span class="type-name">Int32</span>
</div></div><div class="cell"><div class="code-block"><span class="type-name">Float</span> <span class="symbol">=</span> <span class="type-name">Float32</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Casting</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> internalCast (b<span class="symbol">:</span><span class="type-name">Type</span>) (x<span class="command">:a</span>) <span class="symbol">:</span> b <span class="symbol">=</span> %cast b x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">F64ToF</span> (x <span class="symbol">:</span> <span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Float</span>   <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">F32ToF</span> (x <span class="symbol">:</span> <span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Float</span>   <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">FToF64</span> (x <span class="symbol">:</span> <span class="type-name">Float</span>)   <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">FToF32</span> (x <span class="symbol">:</span> <span class="type-name">Float</span>)   <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">I64ToI</span> (x <span class="symbol">:</span> <span class="type-name">Int64</span>)   <span class="symbol">:</span> <span class="type-name">Int</span>     <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">I32ToI</span> (x <span class="symbol">:</span> <span class="type-name">Int32</span>)   <span class="symbol">:</span> <span class="type-name">Int</span>     <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">W8ToI</span>  (x <span class="symbol">:</span> <span class="type-name">Word8</span>)   <span class="symbol">:</span> <span class="type-name">Int</span>     <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">IToI64</span> (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Int64</span>   <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">IToI32</span> (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Int32</span>   <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">IToW8</span>  (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Word8</span>   <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">IToW32</span> (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Word32</span>  <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">IToW64</span> (x <span class="symbol">:</span> <span class="type-name">Int</span>)     <span class="symbol">:</span> <span class="type-name">Word64</span>  <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">W32ToW64</span> (x <span class="symbol">:</span> <span class="type-name">Word32</span>)<span class="symbol">:</span> <span class="type-name">Word64</span>  <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">IToF</span> (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">FToI</span> (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">I64ToRawPtr</span> (x<span class="symbol">:</span><span class="type-name">Int64</span> ) <span class="symbol">:</span> <span class="type-name">RawPtr</span> <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">RawPtrToI64</span> (x<span class="symbol">:</span><span class="type-name">RawPtr</span>) <span class="symbol">:</span> <span class="type-name">Int64</span>  <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="prose-block"><h2>Bitwise operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Bits</span> a
  (<span class="symbol">.&lt;&lt;.</span>)  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> <span class="type-name">Int</span> <span class="symbol">-&gt;</span> a
  (<span class="symbol">.&gt;&gt;.</span>)  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> <span class="type-name">Int</span> <span class="symbol">-&gt;</span> a
  (<span class="symbol">.|.</span>)   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  (<span class="symbol">.&amp;.</span>)   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  (<span class="symbol">.^.</span>)   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Bits</span> <span class="type-name">Word8</span>
  (<span class="symbol">.&lt;&lt;.</span>)  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %shl x (<span class="type-name">IToW8</span> y)
  (<span class="symbol">.&gt;&gt;.</span>)  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %shr x (<span class="type-name">IToW8</span> y)
  (<span class="symbol">.|.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %or x y
  (<span class="symbol">.&amp;.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %and x y
  (<span class="symbol">.^.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %xor x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Bits</span> <span class="type-name">Word32</span>
  (<span class="symbol">.&lt;&lt;.</span>)  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %shl x (<span class="type-name">IToW32</span> y)
  (<span class="symbol">.&gt;&gt;.</span>)  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %shr x (<span class="type-name">IToW32</span> y)
  (<span class="symbol">.|.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %or x y
  (<span class="symbol">.&amp;.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %and x y
  (<span class="symbol">.^.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %xor x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Bits</span> <span class="type-name">Word64</span>
  (<span class="symbol">.&lt;&lt;.</span>)  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %shl x (<span class="type-name">IToW64</span> y)
  (<span class="symbol">.&gt;&gt;.</span>)  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %shr x (<span class="type-name">IToW64</span> y)
  (<span class="symbol">.|.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %or x y
  (<span class="symbol">.&amp;.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %and x y
  (<span class="symbol">.^.</span>)   <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %xor x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> lowWord  (x <span class="symbol">:</span> <span class="type-name">Word64</span>) <span class="symbol">:</span> <span class="type-name">Word32</span> <span class="symbol">=</span> internalCast _ (x <span class="symbol">.&gt;&gt;.</span> 32)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> highWord (x <span class="symbol">:</span> <span class="type-name">Word64</span>) <span class="symbol">:</span> <span class="type-name">Word32</span> <span class="symbol">=</span> internalCast _ x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Basic Arithmetic</h3>
<h4>Add</h4>
<p>Things that can be added.
This defines the <code>Add</code> <a href="https://en.wikipedia.org/wiki/Group_(mathematics)">group</a> and its operators.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Add</span> a
  add <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  sub <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  zero <span class="symbol">:</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+</span>) [<span class="type-name">Add</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> add
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">-</span>) [<span class="type-name">Add</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> sub
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Float64</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fadd x y
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fsub x y
  zero <span class="symbol">=</span> <span class="type-name">FToF64</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Float32</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fadd x y
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fsub x y
  zero <span class="symbol">=</span> <span class="type-name">FToF32</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Int64</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %iadd x y
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %isub x y
  zero <span class="symbol">=</span> <span class="type-name">IToI64</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Int32</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %iadd x y
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %isub x y
  zero <span class="symbol">=</span> <span class="type-name">IToI32</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Word8</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %iadd x y
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %isub x y
  zero <span class="symbol">=</span> <span class="type-name">IToW8</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Word32</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %iadd x y
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %isub x y
  zero <span class="symbol">=</span> <span class="type-name">IToW32</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Word64</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %iadd x y
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %isub x y
  zero <span class="symbol">=</span> <span class="type-name">IToW64</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Unit</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ()
  sub <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ()
  zero <span class="symbol">=</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Add</span> a] <span class="type-name">Add</span> (n<span class="symbol">=&gt;</span>a)
  add <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">+</span> ys<span class="symbol">.</span>i
  sub <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">-</span> ys<span class="symbol">.</span>i
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Add</span> a] <span class="type-name">Add</span> (i<span class="command">:n</span> <span class="symbol">=&gt;</span> (i<span class="symbol">..</span>) <span class="symbol">=&gt;</span> a)  <span class="comment">-- Upper triangular tables
</span>  add <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">+</span> ys<span class="symbol">.</span>i
  sub <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">-</span> ys<span class="symbol">.</span>i
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Add</span> a] <span class="type-name">Add</span> (i<span class="command">:n</span> <span class="symbol">=&gt;</span> (<span class="symbol">..</span>i) <span class="symbol">=&gt;</span> a)  <span class="comment">-- Lower triangular tables
</span>  add <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">+</span> ys<span class="symbol">.</span>i
  sub <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">-</span> ys<span class="symbol">.</span>i
  zero <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> zero
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h4>Mul</h4>
<p>Things that can be multiplied.
This defines the <code>Mul</code> <a href="https://en.wikipedia.org/wiki/Monoid">Monoid</a>, and its operator.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Mul</span> a
  mul <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  one <span class="symbol">:</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">*</span>) [<span class="type-name">Mul</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> mul
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Float64</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fmul x y
  one <span class="symbol">=</span> <span class="type-name">FToF64</span> 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Float32</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fmul x y
  one <span class="symbol">=</span> <span class="type-name">FToF32</span> 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Int64</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %imul x y
  one <span class="symbol">=</span> <span class="type-name">IToI64</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Int32</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %imul x y
  one <span class="symbol">=</span> <span class="type-name">IToI32</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Word8</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %imul x y
  one <span class="symbol">=</span> <span class="type-name">IToW8</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Unit</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ()
  one <span class="symbol">=</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Mul</span> a] <span class="type-name">Mul</span> (n<span class="symbol">=&gt;</span>a)
  mul <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>i <span class="symbol">*</span> ys<span class="symbol">.</span>i
  one <span class="symbol">=</span> <span class="keyword">for</span> _<span class="symbol">.</span> one
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h4>Integral</h4>
<p>Integer-like things.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Integral</span> a
  idiv <span class="symbol">:</span> a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a
  rem  <span class="symbol">:</span> a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span> <span class="type-name">Int64</span>
  idiv <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %idiv x y
  rem  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %irem x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span> <span class="type-name">Int32</span>
  idiv <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %idiv x y
  rem  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %irem x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Integral</span> <span class="type-name">Word8</span>
  idiv <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>  %idiv x y
  rem  <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>  %irem x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h4>Fractional</h4>
<p>Rational-like things.
Includes floating point and two field rational representations.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Fractional</span> a
  divide <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Fractional</span> <span class="type-name">Float64</span>
  divide <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fdiv x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Fractional</span> <span class="type-name">Float32</span>
  divide <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fdiv x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Basic polymorphic functions and types</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&amp;</span>) (a<span class="symbol">:</span><span class="type-name">Type</span>) (b<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">PairType</span> a b
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">,</span>) (x<span class="command">:a</span>) (y<span class="command">:b</span>) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> b) <span class="symbol">=</span> %pair x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fst ((x<span class="symbol">,</span> _)<span class="symbol">:</span> (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> a <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> snd ((_<span class="symbol">,</span> y)<span class="symbol">:</span> (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> b <span class="symbol">=</span> y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> swap ((x<span class="symbol">,</span> y)<span class="symbol">:</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">:</span> (b<span class="symbol">&amp;</span>a) <span class="symbol">=</span> (y<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;&lt;&lt;</span>) (f<span class="symbol">:</span> b <span class="symbol">-&gt;</span> c) (g<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> c <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> f (g x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&gt;&gt;&gt;</span>) (g<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b) (f<span class="symbol">:</span> b <span class="symbol">-&gt;</span> c) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> c <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> f (g x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">flip <span class="symbol">:</span> (a <span class="symbol">-&gt;</span> b <span class="symbol">-&gt;</span> c) <span class="symbol">-&gt;</span> (b <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> c) <span class="symbol">=</span> <span class="symbol">\</span>f x y<span class="symbol">.</span> f y x
</div></div><div class="cell"><div class="code-block">uncurry <span class="symbol">:</span> (a <span class="symbol">-&gt;</span> b <span class="symbol">-&gt;</span> c) <span class="symbol">-&gt;</span> (a <span class="symbol">&amp;</span> b) <span class="symbol">-&gt;</span> c <span class="symbol">=</span> <span class="symbol">\</span>f (x<span class="symbol">,</span>y)<span class="symbol">.</span> f x y
</div></div><div class="cell"><div class="code-block">const <span class="symbol">:</span> a <span class="symbol">-&gt;</span> b <span class="symbol">-&gt;</span> a <span class="symbol">=</span> <span class="symbol">\</span>x _<span class="symbol">.</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Vector spaces</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> [<span class="type-name">Add</span> a] <span class="type-name">VSpace</span> a
  scaleVec <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">.*</span>) [<span class="type-name">VSpace</span> a] <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> scaleVec
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">*.</span>) [<span class="type-name">VSpace</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> <span class="type-name">Float</span> <span class="symbol">-&gt;</span> a <span class="symbol">=</span> flip scaleVec
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">/</span>)  [<span class="type-name">VSpace</span> a] (v<span class="command">:a</span>) (s<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> a <span class="symbol">=</span> divide 1<span class="symbol">.</span>0 s <span class="symbol">.*</span> v
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> neg  [<span class="type-name">VSpace</span> a] (v<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> (<span class="symbol">-</span>1<span class="symbol">.</span>0) <span class="symbol">.*</span> v
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span> <span class="type-name">Float</span>
  scaleVec <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> x <span class="symbol">*</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">VSpace</span> a] <span class="type-name">VSpace</span> (n<span class="symbol">=&gt;</span>a)
  scaleVec <span class="symbol">=</span> <span class="symbol">\</span>s xs<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> s <span class="symbol">.*</span> xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span> <span class="type-name">Unit</span>
  scaleVec <span class="symbol">=</span> <span class="symbol">\</span>_ _<span class="symbol">.</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Boolean type</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  <span class="type-name">False</span>
  <span class="type-name">True</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">BToW8</span> (x <span class="symbol">:</span> <span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Word8</span> <span class="symbol">=</span> %dataConTag x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">W8ToB</span> (x <span class="symbol">:</span> <span class="type-name">Word8</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> %toEnum <span class="type-name">Bool</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&amp;&amp;</span>) (x<span class="symbol">:</span><span class="type-name">Bool</span>) (y<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> <span class="type-name">BToW8</span> x
  y&#39; <span class="symbol">=</span> <span class="type-name">BToW8</span> y
  <span class="type-name">W8ToB</span> <span class="symbol">$</span> %and x&#39; y&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">||</span>) (x<span class="symbol">:</span><span class="type-name">Bool</span>) (y<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> <span class="type-name">BToW8</span> x
  y&#39; <span class="symbol">=</span> <span class="type-name">BToW8</span> y
  <span class="type-name">W8ToB</span> <span class="symbol">$</span> %or x&#39; y&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> not  (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  x&#39; <span class="symbol">=</span> <span class="type-name">BToW8</span> x
  <span class="type-name">W8ToB</span> <span class="symbol">$</span> %not x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Sum types</h2>
<p>A <a href="https://en.wikipedia.org/wiki/Tagged_union">sum type, or tagged union</a> can hold values from a fixed set of types, distinguished by tags.
For those familiar with the C language, they can be though of as a combination of an <code>enum</code> with a <code>union</code>.
Here we define several basic kinds, and some operators on them.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Maybe</span> a <span class="symbol">=</span>
  <span class="type-name">Nothing</span>
  <span class="type-name">Just</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isNothing (x<span class="symbol">:</span><span class="type-name">Maybe</span> a) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span>
  <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">True</span>
  <span class="type-name">Just</span> _ <span class="symbol">-&gt;</span> <span class="type-name">False</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isJust (x<span class="symbol">:</span><span class="type-name">Maybe</span> a) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> not <span class="symbol">$</span> isNothing x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maybe (d<span class="symbol">:</span> b) (f <span class="symbol">:</span> (a <span class="symbol">-&gt;</span> b)) (x<span class="symbol">:</span> <span class="type-name">Maybe</span> a) <span class="symbol">:</span> b <span class="symbol">=</span>
  <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> d
    <span class="type-name">Just</span> x&#39; <span class="symbol">-&gt;</span> f x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> (<span class="symbol">|</span>) a b <span class="symbol">=</span>
  <span class="type-name">Left</span>  a
  <span class="type-name">Right</span> b
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>More Boolean operations</h2>
<p>TODO: move these with the others?</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> select (p<span class="symbol">:</span><span class="type-name">Bool</span>) (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> <span class="keyword">case</span> p <span class="keyword">of</span>
  <span class="type-name">True</span>  <span class="symbol">-&gt;</span> x
  <span class="type-name">False</span> <span class="symbol">-&gt;</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">BToI</span> (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Int</span>  <span class="symbol">=</span> <span class="type-name">W8ToI</span> <span class="symbol">$</span> <span class="type-name">BToW8</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">BToF</span> (x<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> <span class="type-name">IToF</span> (<span class="type-name">BToI</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Ordering</h2>
<p>TODO: move this down to with <code>Ord</code>?</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Ordering</span> <span class="symbol">=</span>
  <span class="type-name">LT</span>
  <span class="type-name">EQ</span>
  <span class="type-name">GT</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">OToW8</span> (x <span class="symbol">:</span> <span class="type-name">Ordering</span>) <span class="symbol">:</span> <span class="type-name">Word8</span> <span class="symbol">=</span> %dataConTag x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Monoid</h3>
<p>A <a href="https://en.wikipedia.org/wiki/Monoid">monoid</a> is a things that have an associative binary operator and an identity element.
This is a very useful and general calls of things.
It includes:</p>
<ul>
<li>Addition and Multiplication of Numbers</li>
<li>Boolean Logic</li>
<li>Concatenation of Lists (including strings)
Monoids support <code>fold</code> operations, and similar.</li>
</ul>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Monoid</span> a
  mempty <span class="symbol">:</span> a
  mcombine <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a  <span class="comment">-- can&#39;t use `&lt;&gt;` just for parser reasons?
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;&gt;</span>) [<span class="type-name">Monoid</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> mcombine
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Monoid</span> a] <span class="type-name">Monoid</span> (n<span class="symbol">=&gt;</span>a)
  mempty <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> mempty
  mcombine <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> mcombine x<span class="symbol">.</span>i y<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> <span class="type-name">AndMonoid</span> <span class="symbol">:</span> <span class="type-name">Monoid</span> <span class="type-name">Bool</span>
  mempty <span class="symbol">=</span> <span class="type-name">True</span>
  mcombine <span class="symbol">=</span> (<span class="symbol">&amp;&amp;</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">named<span class="symbol">-</span><span class="keyword">instance</span> <span class="type-name">OrMonoid</span> <span class="symbol">:</span> <span class="type-name">Monoid</span> <span class="type-name">Bool</span>
  mempty <span class="symbol">=</span> <span class="type-name">False</span>
  mcombine <span class="symbol">=</span> (<span class="symbol">||</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">AddMonoid</span> (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">-&gt;</span> (_<span class="symbol">:</span><span class="type-name">Add</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">Monoid</span> a <span class="symbol">=</span>
  <span class="type-name">A</span> <span class="symbol">=</span> a <span class="comment">-- XXX: Typing `Monoid a` below would quantify it over a, which we don&#39;t want
</span>  named<span class="symbol">-</span><span class="keyword">instance</span> result <span class="symbol">:</span> <span class="type-name">Monoid</span> <span class="type-name">A</span>
    mempty <span class="symbol">=</span> zero
    mcombine <span class="symbol">=</span> add
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">MulMonoid</span> (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">-&gt;</span> (_<span class="symbol">:</span><span class="type-name">Mul</span> a) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">Monoid</span> a <span class="symbol">=</span>
  <span class="type-name">A</span> <span class="symbol">=</span> a <span class="comment">-- XXX: Typing `Monoid a` below would quantify it over a, which we don&#39;t want
</span>  named<span class="symbol">-</span><span class="keyword">instance</span> result <span class="symbol">:</span> <span class="type-name">Monoid</span> <span class="type-name">A</span>
    mempty <span class="symbol">=</span> one
    mcombine <span class="symbol">=</span> mul
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Effects</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Ref</span> (r<span class="symbol">:</span><span class="type-name">Type</span>) (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">Ref</span> r a
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> get  (ref<span class="symbol">:</span><span class="type-name">Ref</span> h s)       <span class="symbol">:</span> {<span class="type-name">State</span> h} s    <span class="symbol">=</span> %get  ref
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">:=</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h s) (x<span class="command">:s</span>) <span class="symbol">:</span> {<span class="type-name">State</span> h} <span class="type-name">Unit</span> <span class="symbol">=</span> %put  ref x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ask  (ref<span class="symbol">:</span><span class="type-name">Ref</span> h r)       <span class="symbol">:</span> {<span class="type-name">Read</span>  h} r    <span class="symbol">=</span> %ask  ref
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">AccumMonoid</span> h w <span class="symbol">=</span> <span class="type-name">UnsafeMkAccumMonoid</span> (<span class="type-name">Monoid</span> w)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="symbol">@</span><span class="keyword">instance</span>
<span class="keyword">def</span> tableAccumMonoid ((<span class="type-name">UnsafeMkAccumMonoid</span> m)<span class="symbol">:</span><span class="type-name">AccumMonoid</span> h w) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">AccumMonoid</span> h (n<span class="symbol">=&gt;</span>w) <span class="symbol">=</span>
  %<span class="keyword">instance</span> mHint <span class="symbol">=</span> m
  <span class="keyword">def</span> liftTableMonoid (tm<span class="symbol">:</span><span class="type-name">Monoid</span> (n<span class="symbol">=&gt;</span>w)) <span class="symbol">?=&gt;</span> <span class="symbol">:</span> <span class="type-name">Monoid</span> (n<span class="symbol">=&gt;</span>w) <span class="symbol">=</span> tm
  <span class="type-name">UnsafeMkAccumMonoid</span> liftTableMonoid
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+=</span>) (am<span class="symbol">:</span><span class="type-name">AccumMonoid</span> h w) <span class="symbol">?=&gt;</span> (ref<span class="symbol">:</span><span class="type-name">Ref</span> h w) (x<span class="command">:w</span>) <span class="symbol">:</span> {<span class="type-name">Accum</span> h} <span class="type-name">Unit</span> <span class="symbol">=</span>
  (<span class="type-name">UnsafeMkAccumMonoid</span> m) <span class="symbol">=</span> am
  %<span class="keyword">instance</span> mHint <span class="symbol">=</span> m
  updater <span class="symbol">=</span> <span class="symbol">\</span>v<span class="symbol">.</span> mcombine v x
  %mextend ref updater
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">!</span>)  (ref<span class="symbol">:</span><span class="type-name">Ref</span> h (n<span class="symbol">=&gt;</span>a)) (i<span class="command">:n</span>) <span class="symbol">:</span> <span class="type-name">Ref</span> h a <span class="symbol">=</span> %indexRef ref i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fstRef (ref<span class="symbol">:</span> <span class="type-name">Ref</span> h (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> <span class="type-name">Ref</span> h a <span class="symbol">=</span> %fstRef ref
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sndRef (ref<span class="symbol">:</span> <span class="type-name">Ref</span> h (a <span class="symbol">&amp;</span> b)) <span class="symbol">:</span> <span class="type-name">Ref</span> h b <span class="symbol">=</span> %sndRef ref
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> runReader
      (init<span class="command">:r</span>)
      (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h r <span class="symbol">-&gt;</span> {<span class="type-name">Read</span> h<span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} a <span class="symbol">=</span>
    <span class="keyword">def</span> explicitAction (h&#39;<span class="symbol">:</span><span class="type-name">Type</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; r) <span class="symbol">:</span> {<span class="type-name">Read</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span> action ref
    %runReader init explicitAction
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withReader
      (init<span class="command">:r</span>)
      (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h r <span class="symbol">-&gt;</span> {<span class="type-name">Read</span> h<span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} a <span class="symbol">=</span>
    runReader init action
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">MonoidLifter</span> (b<span class="symbol">:</span><span class="type-name">Type</span>) (w<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">-&gt;</span> <span class="type-name">AccumMonoid</span> h b <span class="symbol">?=&gt;</span> <span class="type-name">AccumMonoid</span> h w
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> runAccum
      (mlift<span class="symbol">:</span><span class="type-name">MonoidLifter</span> b w) <span class="symbol">?=&gt;</span>
      (bm<span class="symbol">:</span><span class="type-name">Monoid</span> b)
      (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">AccumMonoid</span> h b <span class="symbol">?=&gt;</span> <span class="type-name">Ref</span> h w <span class="symbol">-&gt;</span> {<span class="type-name">Accum</span> h<span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} (a <span class="symbol">&amp;</span> w) <span class="symbol">=</span>
    <span class="comment">-- Normally, only the ?=&gt; lambda binders participate in dictionary synthesis,
</span>    <span class="comment">-- so we need to explicitly declare `m` as a hint.
</span>    %<span class="keyword">instance</span> bmHint <span class="symbol">=</span> bm
    empty <span class="symbol">:</span> b <span class="symbol">=</span> mempty
    combine <span class="symbol">:</span> b <span class="symbol">-&gt;</span> b <span class="symbol">-&gt;</span> b <span class="symbol">=</span> mcombine
    <span class="keyword">def</span> explicitAction (h&#39;<span class="symbol">:</span><span class="type-name">Type</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; w) <span class="symbol">:</span> {<span class="type-name">Accum</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span>
      %<span class="keyword">instance</span> accumBaseMonoidHint <span class="symbol">:</span> <span class="type-name">AccumMonoid</span> h&#39; b <span class="symbol">=</span> <span class="type-name">UnsafeMkAccumMonoid</span> bm
      action ref
    %runWriter empty combine explicitAction
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> yieldAccum
      (mlift<span class="symbol">:</span><span class="type-name">MonoidLifter</span> b w) <span class="symbol">?=&gt;</span>
      (m<span class="symbol">:</span><span class="type-name">Monoid</span> b)
      (action<span class="symbol">:</span> (h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">AccumMonoid</span> h b <span class="symbol">?=&gt;</span> <span class="type-name">Ref</span> h w <span class="symbol">-&gt;</span> {<span class="type-name">Accum</span> h<span class="symbol">|</span>eff} a))
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} w <span class="symbol">=</span>
  snd <span class="symbol">$</span> runAccum m action
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> runState
      (init<span class="command">:s</span>)
      (action<span class="symbol">:</span> h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h s <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h <span class="symbol">|</span>eff} a)
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} (a <span class="symbol">&amp;</span> s) <span class="symbol">=</span>
  <span class="keyword">def</span> explicitAction (h&#39;<span class="symbol">:</span><span class="type-name">Type</span>) (ref<span class="symbol">:</span><span class="type-name">Ref</span> h&#39; s) <span class="symbol">:</span> {<span class="type-name">State</span> h&#39;<span class="symbol">|</span>eff} a <span class="symbol">=</span> action ref
  %runState init explicitAction
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withState
      (init<span class="command">:s</span>)
      (action<span class="symbol">:</span> h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h s <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h <span class="symbol">|</span>eff} a)
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} a <span class="symbol">=</span> fst <span class="symbol">$</span> runState init action
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> yieldState
      (init<span class="command">:s</span>)
      (action<span class="symbol">:</span> h<span class="symbol">:</span><span class="type-name">Type</span> <span class="symbol">?-&gt;</span> <span class="type-name">Ref</span> h s <span class="symbol">-&gt;</span> {<span class="type-name">State</span> h <span class="symbol">|</span>eff} a)
      <span class="symbol">:</span> {<span class="symbol">|</span>eff} s <span class="symbol">=</span> snd <span class="symbol">$</span> runState init action
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafeIO (f<span class="symbol">:</span> <span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span><span class="symbol">|</span>eff} a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} a <span class="symbol">=</span>
  %runIO f
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unreachable (()<span class="symbol">:</span><span class="type-name">Unit</span>) <span class="symbol">:</span> a <span class="symbol">=</span> unsafeIO <span class="keyword">do</span>
  %throwError a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Type classes</h2>
</div></div><div class="cell"><div class="prose-block"><h3>Eq and Ord</h3>
</div></div><div class="cell"><div class="prose-block"><h4>Eq</h4>
<p>Equatable.
Things that we can tell if they are equal or not to other things.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Eq</span> a
  (<span class="symbol">==</span>) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">/=</span>) [<span class="type-name">Eq</span> a] (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> not <span class="symbol">$</span> x <span class="symbol">==</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h4>Ord</h4>
<p>Orderable / Comparable.
Things that can be place in a total order.
i.e. things that can be compared to other things to find if larger, smaller or equal in value.</p>
</div></div><div class="cell"><div class="prose-block"><p>We take the standard false-hood and pretend that this applies to Floats, even though strictly speaking this not true as our floats follow <a href="https://en.wikipedia.org/wiki/IEEE_754">IEEE754</a>, and thus have <code>NaN &lt; 1.0 == false</code> and <code>1.0 &lt; NaN == false</code>.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> [<span class="type-name">Eq</span> a] <span class="type-name">Ord</span> a
  (<span class="symbol">&gt;</span>) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
  (<span class="symbol">&lt;</span>) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;=</span>) [<span class="type-name">Ord</span> a] (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> x<span class="symbol">&lt;</span>y <span class="symbol">||</span> x<span class="symbol">==</span>y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&gt;=</span>) [<span class="type-name">Ord</span> a] (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> x<span class="symbol">&gt;</span>y <span class="symbol">||</span> x<span class="symbol">==</span>y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Float64</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %feq x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Float32</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %feq x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Int64</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %ieq x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Int32</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %ieq x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Word8</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %ieq x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Bool</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">BToW8</span> x <span class="symbol">==</span> <span class="type-name">BToW8</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Unit</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">True</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">RawPtr</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">RawPtrToI64</span> x <span class="symbol">==</span> <span class="type-name">RawPtrToI64</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Float64</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %fgt x y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %flt x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Float32</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %fgt x y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %flt x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Int64</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %igt x y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %ilt x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Int32</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %igt x y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %ilt x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Word8</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %igt x y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">W8ToB</span> <span class="symbol">$</span> %ilt x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> <span class="type-name">Unit</span>
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">False</span>
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">False</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Eq</span> a<span class="symbol">,</span> <span class="type-name">Eq</span> b] <span class="type-name">Eq</span> (a <span class="symbol">&amp;</span> b)
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>(x1<span class="symbol">,</span>x2) (y1<span class="symbol">,</span>y2)<span class="symbol">.</span> x1 <span class="symbol">==</span> y1 <span class="symbol">&amp;&amp;</span> x2 <span class="symbol">==</span> y2
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Ord</span> a<span class="symbol">,</span> <span class="type-name">Ord</span> b] <span class="type-name">Ord</span> (a <span class="symbol">&amp;</span> b)
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>(x1<span class="symbol">,</span>x2) (y1<span class="symbol">,</span>y2)<span class="symbol">.</span> x1 <span class="symbol">&gt;</span> y1 <span class="symbol">||</span> (x1 <span class="symbol">==</span> y1 <span class="symbol">&amp;&amp;</span> x2 <span class="symbol">&gt;</span> y2)
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>(x1<span class="symbol">,</span>x2) (y1<span class="symbol">,</span>y2)<span class="symbol">.</span> x1 <span class="symbol">&lt;</span> y1 <span class="symbol">||</span> (x1 <span class="symbol">==</span> y1 <span class="symbol">&amp;&amp;</span> x2 <span class="symbol">&lt;</span> y2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Ordering</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="type-name">OToW8</span> x <span class="symbol">==</span> <span class="type-name">OToW8</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> scan (init<span class="command">:a</span>) (body<span class="command">:n</span><span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> n<span class="symbol">=&gt;</span>b) <span class="symbol">=</span>
  swap <span class="symbol">$</span> runState init <span class="symbol">\</span>s<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span>
    c <span class="symbol">=</span> get s
    (c&#39;<span class="symbol">,</span> y) <span class="symbol">=</span> body i c
    s <span class="symbol">:=</span> c&#39;
    y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fold (init<span class="command">:a</span>) (body<span class="symbol">:</span>(n<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a)) <span class="symbol">:</span> a <span class="symbol">=</span> fst <span class="symbol">$</span> scan init <span class="symbol">\</span>i x<span class="symbol">.</span> (body i x<span class="symbol">,</span> ())
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> compare [<span class="type-name">Ord</span> a] (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Ordering</span> <span class="symbol">=</span>
  <span class="keyword">if</span> x <span class="symbol">&lt;</span> y
    <span class="keyword">then</span> <span class="type-name">LT</span>
    <span class="keyword">else</span> <span class="keyword">if</span> x <span class="symbol">==</span> y
      <span class="keyword">then</span> <span class="type-name">EQ</span>
      <span class="keyword">else</span> <span class="type-name">GT</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Monoid</span> <span class="type-name">Ordering</span>
  mempty <span class="symbol">=</span> <span class="type-name">EQ</span>
  mcombine <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>
    <span class="keyword">case</span> x <span class="keyword">of</span>
      <span class="type-name">LT</span> <span class="symbol">-&gt;</span> <span class="type-name">LT</span>
      <span class="type-name">GT</span> <span class="symbol">-&gt;</span> <span class="type-name">GT</span>
      <span class="type-name">EQ</span> <span class="symbol">-&gt;</span> y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Eq</span> a] <span class="type-name">Eq</span> (n<span class="symbol">=&gt;</span>a)
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span>
    yieldAccum <span class="type-name">AndMonoid</span> <span class="symbol">\</span>ref<span class="symbol">.</span>
      <span class="keyword">for</span> i<span class="symbol">.</span> ref <span class="symbol">+=</span> xs<span class="symbol">.</span>i <span class="symbol">==</span> ys<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Ord</span> a] <span class="type-name">Ord</span> (n<span class="symbol">=&gt;</span>a)
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span>
    f<span class="symbol">:</span> <span class="type-name">Ordering</span> <span class="symbol">=</span>
        fold <span class="type-name">EQ</span> <span class="symbol">$</span> <span class="symbol">\</span>i c<span class="symbol">.</span> c <span class="symbol">&lt;&gt;</span> (compare xs<span class="symbol">.</span>i ys<span class="symbol">.</span>i)
    f <span class="symbol">==</span> <span class="type-name">GT</span>
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>xs ys<span class="symbol">.</span>
    f<span class="symbol">:</span> <span class="type-name">Ordering</span> <span class="symbol">=</span>
        fold <span class="type-name">EQ</span> <span class="symbol">$</span> <span class="symbol">\</span>i c<span class="symbol">.</span> c <span class="symbol">&lt;&gt;</span> (compare xs<span class="symbol">.</span>i ys<span class="symbol">.</span>i)
    f <span class="symbol">==</span> <span class="type-name">LT</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Elementary/Special Functions</h2>
<p>This is more or less the standard <a href="https://en.wikipedia.org/wiki/C_mathematical_functions">LibM fare</a>.
Roughly it lines up with some definitions of the set of <a href="https://en.wikipedia.org/wiki/Elementary_function">Elementary</a> and/or <a href="https://en.wikipedia.org/wiki/Special_functions">Special</a>.
In truth, nothing is elementary or special except that we humans have decided it is.
Many, but not all of these functions are <a href="https://en.wikipedia.org/wiki/Transcendental_function">Transcendental</a>.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Floating</span> a
  exp    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  exp2   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  log    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  log2   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  log10  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  log1p  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  sin    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  cos    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  tan    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  sinh   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  cosh   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  tanh   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  floor  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  ceil   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  round  <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  sqrt   <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
  pow    <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a
  lgamma <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> lbeta [<span class="type-name">Add</span> a<span class="symbol">,</span> <span class="type-name">Floating</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> lgamma x <span class="symbol">+</span> lgamma y <span class="symbol">-</span> lgamma (x <span class="symbol">+</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: better numerics for very large and small values.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- Using %exp here to avoid circular definition problems.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float32_sinh (x<span class="symbol">:</span><span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> %fdiv (%fsub (%exp x) (%exp (%fsub 0<span class="symbol">.</span>0 x))) 2<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float32_cosh (x<span class="symbol">:</span><span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> %fdiv (%fadd (%exp x) (%exp (%fsub 0<span class="symbol">.</span>0 x))) 2<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float32_tanh (x<span class="symbol">:</span><span class="type-name">Float32</span>) <span class="symbol">:</span> <span class="type-name">Float32</span> <span class="symbol">=</span> %fdiv (%fsub (%exp x) (%exp (%fsub 0<span class="symbol">.</span>0 x))) (%fadd (%exp x) (%exp (%fsub 0<span class="symbol">.</span>0 x)))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: unify this with float32 functions.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float64_sinh (x<span class="symbol">:</span><span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> %fdiv (%fsub (%exp x) (%exp (%fsub (<span class="type-name">FToF64</span> 0<span class="symbol">.</span>0) x))) (<span class="type-name">FToF64</span> 2<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float64_cosh (x<span class="symbol">:</span><span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> %fdiv (%fadd (%exp x) (%exp (%fsub (<span class="type-name">FToF64</span> 0<span class="symbol">.</span>0) x))) (<span class="type-name">FToF64</span> 2<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> float64_tanh (x<span class="symbol">:</span><span class="type-name">Float64</span>) <span class="symbol">:</span> <span class="type-name">Float64</span> <span class="symbol">=</span> (%fdiv (%fsub (%exp x) (%exp (%fsub (<span class="type-name">FToF64</span> 0<span class="symbol">.</span>0) x)))
                                                (%fadd (%exp x) (%exp (%fsub (<span class="type-name">FToF64</span> 0<span class="symbol">.</span>0) x))))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Floating</span> <span class="type-name">Float64</span>
  exp    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %exp x
  exp2   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %exp2   x
  log    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log    x
  log2   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log2   x
  log10  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log10  x
  log1p  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log1p  x
  sin    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %sin    x
  cos    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %cos    x
  tan    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %tan    x
  sinh   <span class="symbol">=</span> float64_sinh
  cosh   <span class="symbol">=</span> float64_cosh
  tanh   <span class="symbol">=</span> float64_tanh
  floor  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %floor  x
  ceil   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %ceil   x
  round  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %round  x
  sqrt   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %sqrt   x
  pow    <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fpow x y
  lgamma <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %lgamma x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Floating</span> <span class="type-name">Float32</span>
  exp    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %exp x
  exp2   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %exp2   x
  log    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log    x
  log2   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log2   x
  log10  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log10  x
  log1p  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %log1p  x
  sin    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %sin    x
  cos    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %cos    x
  tan    <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %tan    x
  sinh   <span class="symbol">=</span> float32_sinh
  cosh   <span class="symbol">=</span> float32_cosh
  tanh   <span class="symbol">=</span> float32_tanh
  floor  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %floor  x
  ceil   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %ceil   x
  round  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %round  x
  sqrt   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %sqrt   x
  pow    <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> %fpow x y
  lgamma <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> %lgamma x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Index set utilities</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Range</span> (low<span class="symbol">:</span><span class="type-name">Int</span>) (high<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">IntRange</span> low high
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Fin</span> (n<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">Range</span> 0 n
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ordinal (i<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %toOrdinal i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> size (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %idxSetSize n
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafeFromOrdinal (n <span class="symbol">:</span> <span class="type-name">Type</span>) (i <span class="symbol">:</span> <span class="type-name">Int</span>) <span class="symbol">:</span> n <span class="symbol">=</span> %unsafeFromOrdinal n i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> iota (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Int</span> <span class="symbol">=</span> <span class="keyword">view</span> i<span class="symbol">.</span> ordinal i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: we want Eq and Ord for all index sets, not just `Fin n`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> (<span class="type-name">Fin</span> n)
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ordinal x <span class="symbol">==</span> ordinal y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Ord</span> (<span class="type-name">Fin</span> n)
  (<span class="symbol">&gt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ordinal x <span class="symbol">&gt;</span> ordinal y
  (<span class="symbol">&lt;</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> ordinal x <span class="symbol">&lt;</span> ordinal y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Raw pointer operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Ptr</span> a <span class="symbol">=</span> <span class="type-name">MkPtr</span> <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> castPtr (ptr<span class="symbol">:</span> <span class="type-name">Ptr</span> a) <span class="symbol">:</span> <span class="type-name">Ptr</span> b <span class="symbol">=</span>
  (<span class="type-name">MkPtr</span> rawPtr) <span class="symbol">=</span> ptr
  <span class="type-name">MkPtr</span> rawPtr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Storable</span> a
  store <span class="symbol">:</span> <span class="type-name">Ptr</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span>
  load  <span class="symbol">:</span> <span class="type-name">Ptr</span> a <span class="symbol">-&gt;</span>      {<span class="type-name">IO</span>} a
  storageSize a <span class="symbol">:</span> <span class="type-name">Int</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span> <span class="type-name">Word8</span>
  store <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr) x<span class="symbol">.</span> %ptrStore ptr x
  load  <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)  <span class="symbol">.</span> %ptrLoad  ptr
  storageSize <span class="symbol">=</span> 1
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span> <span class="type-name">Int32</span>
  store <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr) x<span class="symbol">.</span> %ptrStore (internalCast %<span class="type-name">Int32Ptr</span> ptr) x
  load  <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)  <span class="symbol">.</span> %ptrLoad  (internalCast %<span class="type-name">Int32Ptr</span> ptr)
  storageSize <span class="symbol">=</span> 4
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span> <span class="type-name">Float32</span>
  store <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr) x<span class="symbol">.</span> %ptrStore (internalCast %<span class="type-name">Float32Ptr</span> ptr) x
  load <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)   <span class="symbol">.</span> %ptrLoad  (internalCast %<span class="type-name">Float32Ptr</span> ptr)
  storageSize <span class="symbol">=</span> 4
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Storable</span> (<span class="type-name">Ptr</span> a)
  store <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr) (<span class="type-name">MkPtr</span> x)<span class="symbol">.</span>         %ptrStore (internalCast %<span class="type-name">PtrPtr</span> ptr) x
  load  <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)          <span class="symbol">.</span> <span class="type-name">MkPtr</span> <span class="symbol">$</span> %ptrLoad  (internalCast %<span class="type-name">PtrPtr</span> ptr)
  storageSize <span class="symbol">=</span> 8  <span class="comment">-- TODO: something more portable?
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: Storable instances for other types
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> malloc [<span class="type-name">Storable</span> a] (n<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} (<span class="type-name">Ptr</span> a) <span class="symbol">=</span>
  numBytes <span class="symbol">=</span> storageSize a <span class="symbol">*</span> n
  <span class="type-name">MkPtr</span> <span class="symbol">$</span> %alloc numBytes
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> free (ptr<span class="symbol">:</span><span class="type-name">Ptr</span> a) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  (<span class="type-name">MkPtr</span> ptr&#39;) <span class="symbol">=</span> ptr
  %free ptr&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+&gt;&gt;</span>) [<span class="type-name">Storable</span> a] (ptr<span class="symbol">:</span><span class="type-name">Ptr</span> a) (i<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Ptr</span> a <span class="symbol">=</span>
  (<span class="type-name">MkPtr</span> ptr&#39;) <span class="symbol">=</span> ptr
  i&#39; <span class="symbol">=</span> i <span class="symbol">*</span> storageSize a
  <span class="type-name">MkPtr</span> <span class="symbol">$</span> %ptrOffset ptr&#39; i&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: consider making a Storable instance for tables instead
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> storeTab [<span class="type-name">Storable</span> a] (ptr<span class="symbol">:</span> <span class="type-name">Ptr</span> a) (tab<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  <span class="keyword">for</span>_ i<span class="symbol">.</span> store (ptr <span class="symbol">+&gt;&gt;</span> ordinal i) tab<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> memcpy [<span class="type-name">Storable</span> a] (dest<span class="symbol">:</span><span class="type-name">Ptr</span> a) (src<span class="symbol">:</span><span class="type-name">Ptr</span> a) (n<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  <span class="keyword">for</span>_ i<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span>
    i&#39; <span class="symbol">=</span> ordinal i
    store (dest <span class="symbol">+&gt;&gt;</span> i&#39;) (load <span class="symbol">$</span> src <span class="symbol">+&gt;&gt;</span> i&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: generalize these brackets to allow other effects
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: make sure that freeing happens even if there are run-time errors
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withAlloc [<span class="type-name">Storable</span> a]
      (n<span class="symbol">:</span><span class="type-name">Int</span>) (action<span class="symbol">:</span> <span class="type-name">Ptr</span> a <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} b) <span class="symbol">:</span> {<span class="type-name">IO</span>} b <span class="symbol">=</span>
  ptr <span class="symbol">=</span> malloc n
  result <span class="symbol">=</span> action ptr
  free ptr
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withTabPtr [<span class="type-name">Storable</span> a]
      (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (action <span class="symbol">:</span> <span class="type-name">Ptr</span> a <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} b) <span class="symbol">:</span> {<span class="type-name">IO</span>} b <span class="symbol">=</span>
  withAlloc (size n) <span class="symbol">\</span>ptr<span class="symbol">.</span>
    <span class="keyword">for</span> i<span class="symbol">.</span> store (ptr <span class="symbol">+&gt;&gt;</span> ordinal i) xs<span class="symbol">.</span>i
    action ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tabFromPtr [<span class="type-name">Storable</span> a] (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">-&gt;</span> (ptr<span class="symbol">:</span><span class="type-name">Ptr</span> a) <span class="symbol">:</span> {<span class="type-name">IO</span>} n<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> load <span class="symbol">$</span> ptr <span class="symbol">+&gt;&gt;</span> ordinal i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Miscellaneous common utilities</h2>
</div></div><div class="cell"><div class="code-block">pi <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> 3<span class="symbol">.</span>141592653589793
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> id (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> dup (x<span class="command">:a</span>) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> a) <span class="symbol">=</span> (x<span class="symbol">,</span> x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> map (f<span class="command">:a</span><span class="symbol">-&gt;</span>{<span class="symbol">|</span>eff} b) (xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span>a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} (n<span class="symbol">=&gt;</span>b) <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> f xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> zip (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (ys<span class="command">:n</span><span class="symbol">=&gt;</span>b) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">=</span> <span class="keyword">view</span> i<span class="symbol">.</span> (xs<span class="symbol">.</span>i<span class="symbol">,</span> ys<span class="symbol">.</span>i)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unzip (xys<span class="command">:n</span><span class="symbol">=&gt;</span>(a<span class="symbol">&amp;</span>b)) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span>a <span class="symbol">&amp;</span> n<span class="symbol">=&gt;</span>b) <span class="symbol">=</span> (map fst xys<span class="symbol">,</span> map snd xys)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fanout (n<span class="symbol">:</span><span class="type-name">Type</span>) (x<span class="command">:a</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> <span class="keyword">view</span> i<span class="symbol">.</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sq  [<span class="type-name">Mul</span> a] (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> x <span class="symbol">*</span> x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> abs [<span class="type-name">Add</span> a<span class="symbol">,</span> <span class="type-name">Ord</span> a] (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> select (x <span class="symbol">&gt;</span> zero) x (zero <span class="symbol">-</span> x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> mod (x<span class="symbol">:</span><span class="type-name">Int</span>) (y<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> rem (y <span class="symbol">+</span> rem x y) y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Table Operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Floating</span> a] <span class="type-name">Floating</span> (n<span class="symbol">=&gt;</span>a)
  exp    <span class="symbol">=</span> map exp
  exp2   <span class="symbol">=</span> map exp2
  log    <span class="symbol">=</span> map log
  log2   <span class="symbol">=</span> map log2
  log10  <span class="symbol">=</span> map log10
  log1p  <span class="symbol">=</span> map log1p
  sin    <span class="symbol">=</span> map sin
  cos    <span class="symbol">=</span> map cos
  tan    <span class="symbol">=</span> map tan
  sinh   <span class="symbol">=</span> map sinh
  cosh   <span class="symbol">=</span> map cosh
  tanh   <span class="symbol">=</span> map tanh
  floor  <span class="symbol">=</span> map floor
  ceil   <span class="symbol">=</span> map ceil
  round  <span class="symbol">=</span> map round
  sqrt   <span class="symbol">=</span> map sqrt
  pow    <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> pow x<span class="symbol">.</span>i y<span class="symbol">.</span>i
  lgamma <span class="symbol">=</span> map lgamma
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Axis Restructuring</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> axis1 (x <span class="symbol">:</span> a <span class="symbol">=&gt;</span> b <span class="symbol">=&gt;</span> c) <span class="symbol">:</span> b <span class="symbol">=&gt;</span> a <span class="symbol">=&gt;</span> c <span class="symbol">=</span> <span class="keyword">for</span> j<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> x<span class="symbol">.</span>i<span class="symbol">.</span>j
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> axis2 (x <span class="symbol">:</span> a <span class="symbol">=&gt;</span> b <span class="symbol">=&gt;</span> c <span class="symbol">=&gt;</span> d) <span class="symbol">:</span> c <span class="symbol">=&gt;</span> a <span class="symbol">=&gt;</span> b <span class="symbol">=&gt;</span> d <span class="symbol">=</span> <span class="keyword">for</span> k<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> <span class="keyword">for</span> j<span class="symbol">.</span> x<span class="symbol">.</span>i<span class="symbol">.</span>j<span class="symbol">.</span>k
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reindex (ixr<span class="symbol">:</span> b <span class="symbol">-&gt;</span> a) (tab<span class="symbol">:</span> a<span class="symbol">=&gt;</span>v) <span class="symbol">:</span> b<span class="symbol">=&gt;</span>v <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> tab<span class="symbol">.</span>(ixr i)
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><h3>Reductions</h3>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- `combine` should be a commutative and associative, and form a
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- commutative monoid with `identity`
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reduce (identity<span class="command">:a</span>) (combine<span class="symbol">:</span>(a<span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a)) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span>
  <span class="comment">-- TODO: implement with the accumulator effect
</span>  fold identity (<span class="symbol">\</span>i c<span class="symbol">.</span> combine c xs<span class="symbol">.</span>i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: call this `scan` and call the current `scan` something else
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> scan&#39; (init<span class="command">:a</span>) (body<span class="command">:n</span><span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> snd <span class="symbol">$</span> scan init <span class="symbol">\</span>i x<span class="symbol">.</span> dup (body i x)
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: allow tables-via-lambda and get rid of this
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fsum (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> yieldAccum (<span class="type-name">AddMonoid</span> <span class="type-name">Float</span>) <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> ref <span class="symbol">+=</span> xs i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sum  [<span class="type-name">Add</span> v] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> reduce zero (<span class="symbol">+</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> prod [<span class="type-name">Mul</span> v] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> reduce one  (<span class="symbol">*</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> mean [<span class="type-name">VSpace</span> v] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> sum xs <span class="symbol">/</span> <span class="type-name">IToF</span> (size n)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> std [<span class="type-name">Mul</span> v<span class="symbol">,</span> <span class="type-name">VSpace</span> v<span class="symbol">,</span> <span class="type-name">Floating</span> v] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> sqrt <span class="symbol">$</span> mean (map sq xs) <span class="symbol">-</span> sq (mean xs)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> any (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> reduce <span class="type-name">False</span> (<span class="symbol">||</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> all (xs<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Bool</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> reduce <span class="type-name">True</span>  (<span class="symbol">&amp;&amp;</span>) xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>ApplyN</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> applyN (n<span class="symbol">:</span><span class="type-name">Int</span>) (x<span class="command">:a</span>) (f<span class="command">:a</span> <span class="symbol">-&gt;</span> a) <span class="symbol">:</span> a <span class="symbol">=</span>
  yieldState x <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> _<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span>
    ref <span class="symbol">:=</span> f (get ref)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Linear Algebra</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linspace (n<span class="symbol">:</span><span class="type-name">Type</span>) (low<span class="symbol">:</span><span class="type-name">Float</span>) (high<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  dx <span class="symbol">=</span> (high <span class="symbol">-</span> low) <span class="symbol">/</span> <span class="type-name">IToF</span> (size n)
  <span class="keyword">for</span> i<span class="command">:n</span><span class="symbol">.</span> low <span class="symbol">+</span> <span class="type-name">IToF</span> (ordinal i) <span class="symbol">*</span> dx
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> transpose (x<span class="command">:n</span><span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span>a) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> <span class="keyword">view</span> i j<span class="symbol">.</span> x<span class="symbol">.</span>j<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> vdot (x<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) (y<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> fsum <span class="keyword">view</span> i<span class="symbol">.</span> x<span class="symbol">.</span>i <span class="symbol">*</span> y<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> dot [<span class="type-name">VSpace</span> v] (s<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) (vs<span class="command">:n</span><span class="symbol">=&gt;</span>v) <span class="symbol">:</span> v <span class="symbol">=</span> sum <span class="keyword">for</span> j<span class="symbol">.</span> s<span class="symbol">.</span>j <span class="symbol">.*</span> vs<span class="symbol">.</span>j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- matmul. Better symbol to use? `@`?
</span></div></div><div class="cell"><div class="code-block">(<span class="symbol">**</span>) <span class="symbol">:</span>  (l<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (l<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>
  <span class="keyword">for</span> i k<span class="symbol">.</span> fsum <span class="keyword">view</span> j<span class="symbol">.</span> x<span class="symbol">.</span>i<span class="symbol">.</span>j <span class="symbol">*</span> y<span class="symbol">.</span>j<span class="symbol">.</span>k
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">(<span class="symbol">**.</span>) <span class="symbol">:</span> (n<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> <span class="symbol">\</span>mat v<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> vdot mat<span class="symbol">.</span>i v
</div></div><div class="cell"><div class="code-block">(<span class="symbol">.**</span>) <span class="symbol">:</span> (m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (n<span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">-&gt;</span> (n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">=</span> flip (<span class="symbol">**.</span>)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> inner (x<span class="command">:n</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) (mat<span class="command">:n</span><span class="symbol">=&gt;</span>m<span class="symbol">=&gt;</span><span class="type-name">Float</span>) (y<span class="command">:m</span><span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  fsum <span class="keyword">view</span> (i<span class="symbol">,</span>j)<span class="symbol">.</span> x<span class="symbol">.</span>i <span class="symbol">*</span> mat<span class="symbol">.</span>i<span class="symbol">.</span>j <span class="symbol">*</span> y<span class="symbol">.</span>j
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> eye [<span class="type-name">Add</span> a<span class="symbol">,</span> <span class="type-name">Mul</span> a] <span class="symbol">:</span> n<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">for</span> i j<span class="symbol">.</span> select (ordinal i <span class="symbol">==</span> ordinal j) one zero
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>cumSum</h2>
<p>TODO: Move this to be with reductions?
It's a kind of <code>scan</code>.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cumSum (xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  withState 0<span class="symbol">.</span>0 <span class="symbol">\</span>total<span class="symbol">.</span>
    <span class="keyword">for</span> i<span class="symbol">.</span>
      newTotal <span class="symbol">=</span> get total <span class="symbol">+</span> xs<span class="symbol">.</span>i
      total <span class="symbol">:=</span> newTotal
      newTotal
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Automatic differentiation</h2>
</div></div><div class="cell"><div class="prose-block"><h3>AD operations</h3>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: add vector space constraints
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linearize (f<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> (b <span class="symbol">&amp;</span> a <span class="symbol">--</span>o b) <span class="symbol">=</span> %linearize f x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> jvp (f<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">--</span>o b <span class="symbol">=</span> snd (linearize f x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> transposeLinear (f<span class="command">:a</span> <span class="symbol">--</span>o b) <span class="symbol">:</span> b <span class="symbol">--</span>o a <span class="symbol">=</span> %linearTranspose f
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> vjp (f<span class="command">:a</span><span class="symbol">-&gt;</span>b) (x<span class="command">:a</span>) <span class="symbol">:</span> (b <span class="symbol">&amp;</span> b <span class="symbol">--</span>o a) <span class="symbol">=</span>
  (y<span class="symbol">,</span> df) <span class="symbol">=</span> linearize f x
  (y<span class="symbol">,</span> transposeLinear df)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> grad (f<span class="command">:a</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> snd (vjp f x) 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> deriv (f<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> jvp f x 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> derivRev (f<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> snd (vjp f x) 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Approximate Equality</h3>
<p>TODO: move this outside the AD section to be with equality?</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">HasAllClose</span> a
  allclose <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">HasDefaultTolerance</span> a
  atol <span class="symbol">:</span> a
  rtol <span class="symbol">:</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">~~</span>) [<span class="type-name">HasAllClose</span> a<span class="symbol">,</span> <span class="type-name">HasDefaultTolerance</span> a] <span class="symbol">:</span> a <span class="symbol">-&gt;</span> a <span class="symbol">-&gt;</span> <span class="type-name">Bool</span> <span class="symbol">=</span> allclose atol rtol
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasAllClose</span> <span class="type-name">Float32</span>
  allclose <span class="symbol">=</span> <span class="symbol">\</span>atol rtol x y<span class="symbol">.</span> abs (x <span class="symbol">-</span> y) <span class="symbol">&lt;=</span> (atol <span class="symbol">+</span> rtol <span class="symbol">*</span> abs y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasAllClose</span> <span class="type-name">Float64</span>
  allclose <span class="symbol">=</span> <span class="symbol">\</span>atol rtol x y<span class="symbol">.</span> abs (x <span class="symbol">-</span> y) <span class="symbol">&lt;=</span> (atol <span class="symbol">+</span> rtol <span class="symbol">*</span> abs y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasDefaultTolerance</span> <span class="type-name">Float32</span>
  atol <span class="symbol">=</span> <span class="type-name">FToF32</span> 0<span class="symbol">.</span>00001
  rtol <span class="symbol">=</span> <span class="type-name">FToF32</span> 0<span class="symbol">.</span>0001
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasDefaultTolerance</span> <span class="type-name">Float64</span>
  atol <span class="symbol">=</span> <span class="type-name">FToF64</span> 0<span class="symbol">.</span>00000001
  rtol <span class="symbol">=</span> <span class="type-name">FToF64</span> 0<span class="symbol">.</span>00001
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">HasAllClose</span> t] <span class="type-name">HasAllClose</span> (n<span class="symbol">=&gt;</span>t)
  allclose <span class="symbol">=</span> <span class="symbol">\</span>atol rtol a b<span class="symbol">.</span>
    all <span class="keyword">for</span> i<span class="command">:n</span><span class="symbol">.</span> allclose atol<span class="symbol">.</span>i rtol<span class="symbol">.</span>i a<span class="symbol">.</span>i b<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">HasDefaultTolerance</span> t] <span class="type-name">HasDefaultTolerance</span> (n<span class="symbol">=&gt;</span>t)
  atol <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> atol
  rtol <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> rtol
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>AD Checking tools</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> checkDerivBase (f<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  eps <span class="symbol">=</span> 0<span class="symbol">.</span>01
  ansFwd  <span class="symbol">=</span> deriv    f x
  ansRev  <span class="symbol">=</span> derivRev f x
  ansNumeric <span class="symbol">=</span> (f (x <span class="symbol">+</span> eps) <span class="symbol">-</span> f (x <span class="symbol">-</span> eps)) <span class="symbol">/</span> (2<span class="symbol">.</span> <span class="symbol">*</span> eps)
  ansFwd <span class="symbol">~~</span> ansNumeric <span class="symbol">&amp;&amp;</span> ansRev <span class="symbol">~~</span> ansNumeric
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> checkDeriv (f<span class="symbol">:</span><span class="type-name">Float</span><span class="symbol">-&gt;</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  checkDerivBase f x <span class="symbol">&amp;&amp;</span> checkDerivBase (deriv f) x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Vector support</h2>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: Reenable vector suport once fixed-width types are supported.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- def UNSAFEFromOrdinal (n : Type) (i : Int) : n = %unsafeAsIndex n i
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">--</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- VectorWidth = 4  -- XXX: Keep this synced with the constant defined in Array.hs
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- VectorFloat  = todo
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">--</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- def packVector (a : Float) (b : Float) (c : Float) (d : Float) : VectorFloat = %vectorPack a b c d
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- def indexVector (v : VectorFloat) (i : Fin VectorWidth) : Float = %vectorIndex v i
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">--</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- -- NB: Backends should be smart enough to optimize this to a vector load from v
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- def loadVector (v : (Fin VectorWidth)=&gt;Float) : VectorFloat =
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   idx = Fin VectorWidth
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   (packVector v.(UNSAFEFromOrdinal idx 0)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--               v.(UNSAFEFromOrdinal idx 1)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--               v.(UNSAFEFromOrdinal idx 2)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--               v.(UNSAFEFromOrdinal idx 3))
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- def storeVector (v : VectorFloat) : (Fin VectorWidth)=&gt;Float =
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   idx = Fin VectorWidth
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   [ indexVector v (UNSAFEFromOrdinal idx 0)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   , indexVector v (UNSAFEFromOrdinal idx 1)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   , indexVector v (UNSAFEFromOrdinal idx 2)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   , indexVector v (UNSAFEFromOrdinal idx 3) ]
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">--</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- def broadcastVector (v : Float) : VectorFloat = packVector v v v v
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">--</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- @instance vectorFloatAdd : Add VectorFloat =
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   (MkAdd ( \x y. %vfadd x y )
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--          ( \x y. %vfsub x y )
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--          ( broadcastVector zero ))
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- @instance vectorFloatMul : Mul VectorFloat =
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   MkMul (\x y. %vfmul x y) $ packVector 1.0 1.0 1.0 1.0
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- @instance vectorFloatVSpace : VSpace VectorFloat =
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   MkVSpace vectorFloatAdd \x v. broadcastVector x * v
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Tiling functions</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">Tile</span> (n <span class="symbol">:</span> <span class="type-name">Type</span>) (m <span class="symbol">:</span> <span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> %<span class="type-name">IndexSlice</span> n m
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- One can think of instances of `Tile n m` as injective functions `m -&gt; n`,
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- with the special property that consecutive elements of m map to consecutive
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- elements of n. In this view (+&gt;) is just function application, while ++&gt;
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- is currying followed by function application. We cannot represent currying
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- in isolation, because `Tile n (Tile u v)` does not make sense, unlike `Tile n (u &amp; v)`.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">+&gt;</span>)  (t<span class="symbol">:</span><span class="type-name">Tile</span> n l) (i <span class="symbol">:</span> l) <span class="symbol">:</span> n <span class="symbol">=</span> %sliceOffset t i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">++&gt;</span>) (t <span class="symbol">:</span> <span class="type-name">Tile</span> n (u <span class="symbol">&amp;</span> v)) (i <span class="symbol">:</span> u) <span class="symbol">:</span> <span class="type-name">Tile</span> n v <span class="symbol">=</span> %sliceCurry t i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tile  (fTile <span class="symbol">:</span> (t<span class="symbol">:</span>(<span class="type-name">Tile</span> n l) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} l<span class="symbol">=&gt;</span>a))
          (fScalar <span class="symbol">:</span> n <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> %tiled fTile fScalar
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tile1 (fTile <span class="symbol">:</span> (t<span class="symbol">:</span>(<span class="type-name">Tile</span> n l) <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} m<span class="symbol">=&gt;</span>l<span class="symbol">=&gt;</span>a))
          (fScalar <span class="symbol">:</span> n <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} m<span class="symbol">=&gt;</span>a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} m<span class="symbol">=&gt;</span>n<span class="symbol">=&gt;</span>a <span class="symbol">=</span> %tiledd fTile fScalar
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: This should become just `loadVector $ for i. arr.(t +&gt; i)`
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--       once we are able to eliminate temporary arrays. Until then, we inline for performance...
</span></div></div><div class="cell"><div class="code-block"><span class="symbol">--</span><span class="keyword">def</span> loadTile (t <span class="symbol">:</span> <span class="type-name">Tile</span> n (<span class="type-name">Fin</span> <span class="type-name">VectorWidth</span>)) (arr <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">VectorFloat</span> <span class="symbol">=</span>
</div></div><div class="cell"><div class="code-block"><span class="comment">--  idx = Fin VectorWidth
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--  (packVector arr.(t +&gt; UNSAFEFromOrdinal idx 0)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--              arr.(t +&gt; UNSAFEFromOrdinal idx 1)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--              arr.(t +&gt; UNSAFEFromOrdinal idx 2)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--              arr.(t +&gt; UNSAFEFromOrdinal idx 3))
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Length-erased lists</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  <span class="type-name">AsList</span> n<span class="symbol">:</span><span class="type-name">Int</span> elements<span class="symbol">:</span>(<span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> a)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Eq</span> a] <span class="type-name">Eq</span> (<span class="type-name">List</span> a)
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">AsList</span> nx xs) (<span class="type-name">AsList</span> ny ys)<span class="symbol">.</span>
    <span class="keyword">if</span> nx <span class="symbol">/=</span> ny
      <span class="keyword">then</span> <span class="type-name">False</span>
      <span class="keyword">else</span> all <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> nx)<span class="symbol">.</span>
        xs<span class="symbol">.</span>i <span class="symbol">==</span> ys<span class="symbol">.</span>(unsafeFromOrdinal _ (ordinal i))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> unsafeCastTable (m<span class="symbol">:</span><span class="type-name">Type</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>(unsafeFromOrdinal _ (ordinal i))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> toList (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  n&#39; <span class="symbol">=</span> size n
  <span class="type-name">AsList</span> _ <span class="symbol">$</span> unsafeCastTable (<span class="type-name">Fin</span> n&#39;) xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Monoid</span> (<span class="type-name">List</span> a)
  mempty <span class="symbol">=</span> <span class="type-name">AsList</span> _ []
  mcombine <span class="symbol">=</span> <span class="symbol">\</span>x y<span class="symbol">.</span>
    (<span class="type-name">AsList</span> nx xs) <span class="symbol">=</span> x
    (<span class="type-name">AsList</span> ny ys) <span class="symbol">=</span> y
    nz <span class="symbol">=</span> nx <span class="symbol">+</span> ny
    <span class="type-name">AsList</span> _ <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> nz)<span class="symbol">.</span>
      i&#39; <span class="symbol">=</span> ordinal i
      <span class="keyword">case</span> i&#39; <span class="symbol">&lt;</span> nx <span class="keyword">of</span>
        <span class="type-name">True</span>  <span class="symbol">-&gt;</span> xs<span class="symbol">.</span>(unsafeFromOrdinal _ i&#39;)
        <span class="type-name">False</span> <span class="symbol">-&gt;</span> ys<span class="symbol">.</span>(unsafeFromOrdinal _ (i&#39; <span class="symbol">-</span> nx))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> <span class="type-name">ListMonoid</span> (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> <span class="type-name">Monoid</span> (<span class="type-name">List</span> a) <span class="symbol">=</span>
  <span class="type-name">A</span> <span class="symbol">=</span> a <span class="comment">-- XXX: Typing `Monoid a` below would quantify it over a,
</span>        <span class="comment">--      which we don&#39;t want.
</span>  named<span class="symbol">-</span><span class="keyword">instance</span> result <span class="symbol">:</span> <span class="type-name">Monoid</span> (<span class="type-name">List</span> <span class="type-name">A</span>)
    mempty <span class="symbol">=</span> mempty
    mcombine <span class="symbol">=</span> mcombine
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> append [<span class="type-name">AccumMonoid</span> h (<span class="type-name">List</span> a)]
  (list<span class="symbol">:</span> <span class="type-name">Ref</span> h (<span class="type-name">List</span> a)) (x<span class="command">:a</span>) <span class="symbol">:</span> {<span class="type-name">Accum</span> h} <span class="type-name">Unit</span> <span class="symbol">=</span>
    list <span class="symbol">+=</span> <span class="type-name">AsList</span> 1 [x]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> filter (condition<span class="command">:a</span><span class="symbol">-&gt;</span><span class="type-name">Bool</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  yieldAccum (<span class="type-name">ListMonoid</span> a) <span class="symbol">\</span>list<span class="symbol">.</span>
    <span class="keyword">for</span> i<span class="symbol">.</span>
      <span class="keyword">if</span> condition xs<span class="symbol">.</span>i
        <span class="keyword">then</span> append list xs<span class="symbol">.</span>i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> argFilter (condition<span class="command">:a</span><span class="symbol">-&gt;</span><span class="type-name">Bool</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> <span class="type-name">List</span> n <span class="symbol">=</span>
  <span class="comment">-- Returns all indices where the condition is true.
</span>  yieldAccum (<span class="type-name">ListMonoid</span> n) <span class="symbol">\</span>list<span class="symbol">.</span>
    <span class="keyword">for</span> i<span class="symbol">.</span>
      <span class="keyword">if</span> condition xs<span class="symbol">.</span>i
        <span class="keyword">then</span> append list i
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><h2>Isomorphisms</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Iso</span> a b <span class="symbol">=</span> <span class="type-name">MkIso</span> { fwd<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b <span class="symbol">&amp;</span> bwd<span class="symbol">:</span> b <span class="symbol">-&gt;</span> a }
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> appIso (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a b) (x<span class="command">:a</span>) <span class="symbol">:</span> b <span class="symbol">=</span>
  (<span class="type-name">MkIso</span> {fwd<span class="symbol">,</span> bwd}) <span class="symbol">=</span> iso
  fwd x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> flipIso (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a b) <span class="symbol">:</span> <span class="type-name">Iso</span> b a <span class="symbol">=</span>
  (<span class="type-name">MkIso</span> {fwd<span class="symbol">,</span> bwd}) <span class="symbol">=</span> iso
  <span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>bwd<span class="symbol">,</span> bwd<span class="symbol">=</span>fwd}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> revIso (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a b) (x<span class="command">:b</span>) <span class="symbol">:</span> a <span class="symbol">=</span> appIso (flipIso iso) x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">idIso <span class="symbol">:</span> <span class="type-name">Iso</span> a a <span class="symbol">=</span> <span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>id<span class="symbol">,</span> bwd<span class="symbol">=</span>id}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&amp;&gt;&gt;</span>) (iso1<span class="symbol">:</span> <span class="type-name">Iso</span> a b) (iso2<span class="symbol">:</span> <span class="type-name">Iso</span> b c) <span class="symbol">:</span> <span class="type-name">Iso</span> a c <span class="symbol">=</span>
  (<span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>fwd1<span class="symbol">,</span> bwd<span class="symbol">=</span>bwd1}) <span class="symbol">=</span> iso1
  (<span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>fwd2<span class="symbol">,</span> bwd<span class="symbol">=</span>bwd2}) <span class="symbol">=</span> iso2
  <span class="type-name">MkIso</span> {fwd<span class="symbol">=</span>(fwd1 <span class="symbol">&gt;&gt;&gt;</span> fwd2)<span class="symbol">,</span> bwd<span class="symbol">=</span>(bwd1 <span class="symbol">&lt;&lt;&lt;</span> bwd2)}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">&lt;&lt;&amp;</span>) (iso2<span class="symbol">:</span> <span class="type-name">Iso</span> b c) (iso1<span class="symbol">:</span> <span class="type-name">Iso</span> a b) <span class="symbol">:</span> <span class="type-name">Iso</span> a c <span class="symbol">=</span> iso1 <span class="symbol">&amp;&gt;&gt;</span> iso2
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Lens-like accessors</h3>
<p>note: <code>#foo is an Iso {foo: a &amp; ...b} (a &amp; {&amp;...b}))</code></p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> getAt  (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> b <span class="symbol">=</span> fst <span class="symbol">&lt;&lt;&lt;</span> appIso iso
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> popAt  (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) <span class="symbol">:</span> a <span class="symbol">-&gt;</span> c <span class="symbol">=</span> snd <span class="symbol">&lt;&lt;&lt;</span> appIso iso
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> pushAt (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) (x<span class="command">:b</span>) (r<span class="command">:c</span>) <span class="symbol">:</span> a <span class="symbol">=</span> revIso iso (x<span class="symbol">,</span> r)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> setAt  (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) (x<span class="command">:b</span>) (r<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span>
  pushAt iso x <span class="symbol">$</span> popAt iso r
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Prism-like accessors</h3>
<p>note: <code>#?foo is an Iso {foo: a | ...b} (a | {|...b}))</code></p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> matchWith (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">|</span> c)) (x<span class="symbol">:</span> a) <span class="symbol">:</span> <span class="type-name">Maybe</span> b <span class="symbol">=</span>
  <span class="keyword">case</span> appIso iso x <span class="keyword">of</span>
    <span class="type-name">Left</span> x <span class="symbol">-&gt;</span> <span class="type-name">Just</span> x
    <span class="type-name">Right</span> _ <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> buildWith (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">|</span> c)) (x<span class="symbol">:</span> b) <span class="symbol">:</span> a <span class="symbol">=</span> revIso iso <span class="symbol">$</span> <span class="type-name">Left</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">swapPairIso <span class="symbol">:</span> <span class="type-name">Iso</span> (a <span class="symbol">&amp;</span> b) (b <span class="symbol">&amp;</span> a) <span class="symbol">=</span>
  <span class="type-name">MkIso</span> {fwd <span class="symbol">=</span> <span class="symbol">\</span>(a<span class="symbol">,</span> b)<span class="symbol">.</span> (b<span class="symbol">,</span> a)<span class="symbol">,</span> bwd <span class="symbol">=</span> <span class="symbol">\</span>(b<span class="symbol">,</span> a)<span class="symbol">.</span> (a<span class="symbol">,</span> b)}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Complement lens</h3>
<p>Complement the focus of a lens-like isomorphism</p>
</div></div><div class="cell"><div class="code-block">exceptLens <span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c) <span class="symbol">-&gt;</span> <span class="type-name">Iso</span> a (c <span class="symbol">&amp;</span> b) <span class="symbol">=</span> <span class="symbol">\</span>iso<span class="symbol">.</span> iso <span class="symbol">&amp;&gt;&gt;</span> swapPairIso
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">swapEitherIso <span class="symbol">:</span> <span class="type-name">Iso</span> (a <span class="symbol">|</span> b) (b <span class="symbol">|</span> a) <span class="symbol">=</span>
  fwd <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span> l <span class="symbol">-&gt;</span> <span class="type-name">Right</span> l
    <span class="type-name">Right</span> r <span class="symbol">-&gt;</span> <span class="type-name">Left</span> r
  bwd <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> <span class="keyword">case</span> x <span class="keyword">of</span>
    <span class="type-name">Left</span> r <span class="symbol">-&gt;</span> <span class="type-name">Right</span> r
    <span class="type-name">Right</span> l <span class="symbol">-&gt;</span> <span class="type-name">Left</span> l
  <span class="type-name">MkIso</span> {fwd<span class="symbol">,</span> bwd}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Complement prism</h3>
<p>Complement the focus of a prism-like isomorphism</p>
</div></div><div class="cell"><div class="code-block">exceptPrism <span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">|</span> c) <span class="symbol">-&gt;</span> <span class="type-name">Iso</span> a (c <span class="symbol">|</span> b) <span class="symbol">=</span> <span class="symbol">\</span>iso<span class="symbol">.</span> iso <span class="symbol">&amp;&gt;&gt;</span> swapEitherIso
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Use a lens-like iso to split a 1d table into a 2d table
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> overLens (iso<span class="symbol">:</span> <span class="type-name">Iso</span> a (b <span class="symbol">&amp;</span> c)) (tab<span class="symbol">:</span> a<span class="symbol">=&gt;</span>v) <span class="symbol">:</span> (b<span class="symbol">=&gt;</span>c<span class="symbol">=&gt;</span>v) <span class="symbol">=</span>
  <span class="keyword">for</span> i j<span class="symbol">.</span> tab<span class="symbol">.</span>(revIso iso (i<span class="symbol">,</span> j))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Zipper</h3>
<p>Zipper isomorphisms to easily specify many record/variant fields:</p>
<pre><code>#&amp;foo is an Iso ({&amp;...l} &amp; {foo:a &amp; ...r}) ({foo:a &amp; ...l} &amp; {&amp;...r})
#|foo is an Iso ({|...l} | {foo:a | ...r}) ({foo:a | ...l} | {|...r})
</code></pre>
</div></div><div class="cell"><div class="prose-block"><p>Convert a record zipper isomorphism to a normal lens-like isomorphism
by using <code>splitR &amp;&gt;&gt; iso</code></p>
</div></div><div class="cell"><div class="code-block">splitR <span class="symbol">:</span> <span class="type-name">Iso</span> a ({<span class="symbol">&amp;</span>} <span class="symbol">&amp;</span> a) <span class="symbol">=</span> <span class="type-name">MkIso</span> {fwd<span class="symbol">=\</span>x<span class="symbol">.</span> ({}<span class="symbol">,</span> x)<span class="symbol">,</span> bwd<span class="symbol">=\</span>({}<span class="symbol">,</span> x)<span class="symbol">.</span> x}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> overFields (iso<span class="symbol">:</span> <span class="type-name">Iso</span> ({<span class="symbol">&amp;</span>} <span class="symbol">&amp;</span> a) (b <span class="symbol">&amp;</span> c)) (tab<span class="symbol">:</span> a<span class="symbol">=&gt;</span>v) <span class="symbol">:</span> b<span class="symbol">=&gt;</span>c<span class="symbol">=&gt;</span>v <span class="symbol">=</span>
  overLens (splitR <span class="symbol">&amp;&gt;&gt;</span> iso) tab
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><p>Convert a variant zipper isomorphism to a normal prism-like isomorphism
by using <code>splitV &amp;&gt;&gt; iso</code></p>
</div></div><div class="cell"><div class="code-block">splitV <span class="symbol">:</span> <span class="type-name">Iso</span> a ({<span class="symbol">|</span>} <span class="symbol">|</span> a) <span class="symbol">=</span>
  <span class="type-name">MkIso</span> {fwd<span class="symbol">=\</span>x<span class="symbol">.</span> <span class="type-name">Right</span> x<span class="symbol">,</span> bwd<span class="symbol">=\</span>v<span class="symbol">.</span> <span class="keyword">case</span> v <span class="keyword">of</span> <span class="type-name">Right</span> x <span class="symbol">-&gt;</span> x}
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sliceFields (iso<span class="symbol">:</span> <span class="type-name">Iso</span> ({<span class="symbol">|</span>} <span class="symbol">|</span> a) (b <span class="symbol">|</span> c)) (tab<span class="symbol">:</span> a<span class="symbol">=&gt;</span>v) <span class="symbol">:</span> b<span class="symbol">=&gt;</span>v <span class="symbol">=</span>
  reindex (buildWith <span class="symbol">$</span> splitV <span class="symbol">&amp;&gt;&gt;</span> iso) tab
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Dynamic buffer</h2>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: would be nice to be able to use records here
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">DynBuffer</span> a <span class="symbol">=</span>
  <span class="type-name">MkDynBuffer</span> { size    <span class="symbol">:</span> <span class="type-name">Ptr</span> <span class="type-name">Int</span>
              <span class="symbol">&amp;</span> maxSize <span class="symbol">:</span> <span class="type-name">Ptr</span> <span class="type-name">Int</span>
              <span class="symbol">&amp;</span> buffer  <span class="symbol">:</span> <span class="type-name">Ptr</span> (<span class="type-name">Ptr</span> a) }
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withDynamicBuffer [<span class="type-name">Storable</span> a]
      (action<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} b) <span class="symbol">:</span> {<span class="type-name">IO</span>} b <span class="symbol">=</span>
  initMaxSize <span class="symbol">=</span> 256
  withAlloc 1 <span class="symbol">\</span>sizePtr<span class="symbol">.</span> withAlloc 1 <span class="symbol">\</span>maxSizePtr<span class="symbol">.</span> withAlloc 1 <span class="symbol">\</span>bufferPtr<span class="symbol">.</span>
    store sizePtr 0
    store maxSizePtr initMaxSize
    store bufferPtr <span class="symbol">$</span> malloc initMaxSize
    result <span class="symbol">=</span> action <span class="symbol">$</span> <span class="type-name">MkDynBuffer</span> { size    <span class="symbol">=</span> sizePtr
                                  <span class="symbol">,</span> maxSize <span class="symbol">=</span> maxSizePtr
                                  <span class="symbol">,</span> buffer  <span class="symbol">=</span> bufferPtr }

    free <span class="symbol">$</span> load bufferPtr
    result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maybeIncreaseBufferSize [<span class="type-name">Storable</span> a]
    ((<span class="type-name">MkDynBuffer</span> db)<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a) (sizeDelta<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  size    <span class="symbol">=</span> load <span class="symbol">$</span> getAt <span class="iso-sugar">#size</span>    db
  maxSize <span class="symbol">=</span> load <span class="symbol">$</span> getAt <span class="iso-sugar">#maxSize</span> db
  bufPtr  <span class="symbol">=</span> load <span class="symbol">$</span> getAt <span class="iso-sugar">#buffer</span>  db
  newSize <span class="symbol">=</span> sizeDelta <span class="symbol">+</span> size
  <span class="keyword">if</span> newSize <span class="symbol">&gt;</span> maxSize <span class="keyword">then</span>
    <span class="comment">-- TODO: maybe this should use integer arithmetic?
</span>    newMaxSize <span class="symbol">=</span> <span class="type-name">FToI</span> <span class="symbol">$</span> pow 2<span class="symbol">.</span>0 (ceil <span class="symbol">$</span> log2 <span class="symbol">$</span> <span class="type-name">IToF</span> newSize)
    newBufPtr <span class="symbol">=</span> malloc newMaxSize
    memcpy newBufPtr bufPtr size
    free bufPtr
    store (getAt <span class="iso-sugar">#maxSize</span> db) newMaxSize
    store (getAt <span class="iso-sugar">#buffer</span>  db) newBufPtr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> addAtIntPtr (ptr<span class="symbol">:</span> <span class="type-name">Ptr</span> <span class="type-name">Int</span>) (n<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  store ptr (load ptr <span class="symbol">+</span> n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> extendDynBuffer [<span class="type-name">Storable</span> a]
    (buf<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a) (new<span class="symbol">:</span><span class="type-name">List</span> a) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  (<span class="type-name">AsList</span> n xs) <span class="symbol">=</span> new
  maybeIncreaseBufferSize buf n
  (<span class="type-name">MkDynBuffer</span> db) <span class="symbol">=</span> buf
  bufPtr <span class="symbol">=</span> load <span class="symbol">$</span> getAt <span class="iso-sugar">#buffer</span> db
  size   <span class="symbol">=</span> load <span class="symbol">$</span> getAt <span class="iso-sugar">#size</span> db
  storeTab (bufPtr <span class="symbol">+&gt;&gt;</span> size) xs
  addAtIntPtr (getAt <span class="iso-sugar">#size</span> db) n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> loadDynBuffer [<span class="type-name">Storable</span> a]
      (buf<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a) <span class="symbol">:</span> {<span class="type-name">IO</span>} (<span class="type-name">List</span> a) <span class="symbol">=</span>
  (<span class="type-name">MkDynBuffer</span> db) <span class="symbol">=</span> buf
  bufPtr <span class="symbol">=</span> load <span class="symbol">$</span> getAt <span class="iso-sugar">#buffer</span> db
  size   <span class="symbol">=</span> load <span class="symbol">$</span> getAt <span class="iso-sugar">#size</span> db
  <span class="type-name">AsList</span> size <span class="symbol">$</span> tabFromPtr _ bufPtr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> pushDynBuffer [<span class="type-name">Storable</span> a]
      (buf<span class="symbol">:</span> <span class="type-name">DynBuffer</span> a) (x<span class="command">:a</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  extendDynBuffer buf <span class="symbol">$</span> <span class="type-name">AsList</span> _ [x]
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Strings and Characters</h2>
</div></div><div class="cell"><div class="code-block"><span class="type-name">String</span> <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">List</span> <span class="type-name">Char</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> stringFromCharPtr (n<span class="symbol">:</span><span class="type-name">Int</span>) (ptr<span class="symbol">:</span><span class="type-name">Ptr</span> <span class="type-name">Char</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">String</span> <span class="symbol">=</span>
  <span class="type-name">AsList</span> n <span class="symbol">$</span> tabFromPtr _ ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO. This is ASCII code point. It really should be Int32 for Unicode codepoint
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> codepoint (c<span class="symbol">:</span><span class="type-name">Char</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> <span class="type-name">W8ToI</span> c
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Show interface</h3>
<p>For things that can be shown.
<code>show</code> gives a string representation of its input.
No particular promises are made to exactly what that representation will contain.
In particular it is <strong>not</strong> promised to be parseable.
Nor does it promise a particular level of precision for numeric values.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Show</span> a
  show <span class="symbol">:</span> a <span class="symbol">-&gt;</span> <span class="type-name">String</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span> <span class="type-name">String</span>
  show <span class="symbol">=</span> id
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span> <span class="type-name">Int32</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> unsafeIO <span class="keyword">do</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> %ffi showInt32 (<span class="type-name">Int32</span> <span class="symbol">&amp;</span> <span class="type-name">RawPtr</span>) x
    stringFromCharPtr n <span class="symbol">$</span> <span class="type-name">MkPtr</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span> <span class="type-name">Int64</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> unsafeIO <span class="keyword">do</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> %ffi showInt64 (<span class="type-name">Int32</span> <span class="symbol">&amp;</span> <span class="type-name">RawPtr</span>) x
    stringFromCharPtr n <span class="symbol">$</span> <span class="type-name">MkPtr</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span> <span class="type-name">Float32</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> unsafeIO <span class="keyword">do</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> %ffi showFloat32 (<span class="type-name">Int32</span> <span class="symbol">&amp;</span> <span class="type-name">RawPtr</span>) x
    stringFromCharPtr n <span class="symbol">$</span> <span class="type-name">MkPtr</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Show</span> <span class="type-name">Float64</span>
  show <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">.</span> unsafeIO <span class="keyword">do</span>
    (n<span class="symbol">,</span> ptr) <span class="symbol">=</span> %ffi showFloat64 (<span class="type-name">Int32</span> <span class="symbol">&amp;</span> <span class="type-name">RawPtr</span>) x
    stringFromCharPtr n <span class="symbol">$</span> <span class="type-name">MkPtr</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Show</span> a<span class="symbol">,</span> <span class="type-name">Show</span> b] <span class="type-name">Show</span> (a <span class="symbol">&amp;</span> b)
  show <span class="symbol">=</span> <span class="symbol">\</span>(a<span class="symbol">,</span> b)<span class="symbol">.</span> &quot;(&quot; <span class="symbol">&lt;&gt;</span> show a <span class="symbol">&lt;&gt;</span> &quot;<span class="symbol">,</span> &quot; <span class="symbol">&lt;&gt;</span> show b <span class="symbol">&lt;&gt;</span> &quot;)&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>pipe-like reverse function application</h2>
<p>TODO: move this</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">|&gt;</span>) (x<span class="command">:a</span>) (f<span class="symbol">:</span> a <span class="symbol">-&gt;</span> b) <span class="symbol">:</span> b <span class="symbol">=</span> f x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Floating-point helper functions</h2>
<p>TODO: Move these to be with Elementary/Special functions. Or move those to be here.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> sign (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="keyword">case</span> x <span class="symbol">&gt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> 1<span class="symbol">.</span>0
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
      <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="symbol">-</span>1<span class="symbol">.</span>0
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> copysign (a<span class="symbol">:</span><span class="type-name">Float</span>) (b<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="keyword">case</span> b <span class="symbol">&gt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> a
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> b <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
      <span class="type-name">True</span> <span class="symbol">-&gt;</span> (<span class="symbol">-</span>a)
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: use IEEE floating-point builtins.
</span></div></div><div class="cell"><div class="code-block">infinity <span class="symbol">=</span> 1<span class="symbol">.</span>0 <span class="symbol">/</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">nan      <span class="symbol">=</span> 0<span class="symbol">.</span>0 <span class="symbol">/</span> 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: use IEEE floating-point builtins.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isinf (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> (x <span class="symbol">==</span> infinity) <span class="symbol">||</span> (x <span class="symbol">==</span> <span class="symbol">-</span>infinity)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isnan (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> not (x <span class="symbol">&gt;=</span> x <span class="symbol">&amp;&amp;</span> x <span class="symbol">&lt;=</span> x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: use IEEE-754R 5.11: Floating Point Comparison Relation cmpUnordered.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> either_is_nan (x<span class="symbol">:</span><span class="type-name">Float</span>) (y<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> (isnan x) <span class="symbol">||</span> (isnan y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>File system operations</h2>
</div></div><div class="cell"><div class="code-block"><span class="type-name">FilePath</span> <span class="symbol">:</span> <span class="type-name">Type</span> <span class="symbol">=</span> <span class="type-name">String</span>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">CString</span> <span class="symbol">=</span> <span class="type-name">MkCString</span> <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> nullRawPtr <span class="symbol">:</span> <span class="type-name">RawPtr</span> <span class="symbol">=</span> <span class="type-name">I64ToRawPtr</span> <span class="symbol">$</span> <span class="type-name">IToI64</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fromNullableRawPtr (ptr<span class="symbol">:</span><span class="type-name">RawPtr</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> (<span class="type-name">Ptr</span> a) <span class="symbol">=</span>
  <span class="keyword">if</span> ptr <span class="symbol">==</span> nullRawPtr
    <span class="keyword">then</span> <span class="type-name">Nothing</span>
    <span class="keyword">else</span> <span class="type-name">Just</span> <span class="symbol">$</span> <span class="type-name">MkPtr</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cStringPtr (s<span class="symbol">:</span><span class="type-name">CString</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> (<span class="type-name">Ptr</span> <span class="type-name">Char</span>) <span class="symbol">=</span>
  (<span class="type-name">MkCString</span> ptr) <span class="symbol">=</span> s
  fromNullableRawPtr ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">StreamMode</span> <span class="symbol">=</span>
  <span class="type-name">ReadMode</span>
  <span class="type-name">WriteMode</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Stream</span> mode<span class="symbol">:</span><span class="type-name">StreamMode</span> <span class="symbol">=</span> <span class="type-name">MkStream</span> <span class="type-name">RawPtr</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: check the string contains no nulls
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withCString (s<span class="symbol">:</span><span class="type-name">String</span>) (action<span class="symbol">:</span> <span class="type-name">CString</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a) <span class="symbol">:</span> {<span class="type-name">IO</span>} a <span class="symbol">=</span>
  (<span class="type-name">AsList</span> n s&#39;) <span class="symbol">=</span> s <span class="symbol">&lt;&gt;</span> &quot;<span class="symbol">\</span><span class="type-name">NUL</span>&quot;
  withTabPtr s&#39; <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)<span class="symbol">.</span> action <span class="symbol">$</span> <span class="type-name">MkCString</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Stream IO</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fopen (path<span class="symbol">:</span><span class="type-name">String</span>) (mode<span class="symbol">:</span><span class="type-name">StreamMode</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} (<span class="type-name">Stream</span> mode) <span class="symbol">=</span>
  modeStr <span class="symbol">=</span> <span class="keyword">case</span> mode <span class="keyword">of</span>
    <span class="type-name">ReadMode</span>  <span class="symbol">-&gt;</span> &quot;r&quot;
    <span class="type-name">WriteMode</span> <span class="symbol">-&gt;</span> &quot;w&quot;
  withCString path <span class="symbol">\</span>(<span class="type-name">MkCString</span> pathPtr)<span class="symbol">.</span>
    withCString modeStr <span class="symbol">\</span>(<span class="type-name">MkCString</span> modePtr)<span class="symbol">.</span>
      <span class="type-name">MkStream</span> <span class="symbol">$</span> %ffi fopen <span class="type-name">RawPtr</span> pathPtr modePtr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fclose (stream<span class="symbol">:</span><span class="type-name">Stream</span> mode) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  (<span class="type-name">MkStream</span> stream&#39;) <span class="symbol">=</span> stream
  %ffi fclose <span class="type-name">Int64</span> stream&#39;
  ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fwrite (stream<span class="symbol">:</span><span class="type-name">Stream</span> <span class="type-name">WriteMode</span>) (s<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  (<span class="type-name">MkStream</span> stream&#39;) <span class="symbol">=</span> stream
  (<span class="type-name">AsList</span> n s&#39;) <span class="symbol">=</span> s
  withTabPtr s&#39; <span class="symbol">\</span>(<span class="type-name">MkPtr</span> ptr)<span class="symbol">.</span>
    %ffi fwrite <span class="type-name">Int64</span> ptr (<span class="type-name">IToI64</span> 1) (<span class="type-name">IToI64</span> n) stream&#39;
  %ffi fflush <span class="type-name">Int64</span> stream&#39;
  ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Iteration</h3>
<p>TODO: move this out of the file-system section</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> while (body<span class="symbol">:</span> <span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">Bool</span>) <span class="symbol">:</span> {<span class="symbol">|</span>eff} <span class="type-name">Unit</span> <span class="symbol">=</span>
  body&#39; <span class="symbol">:</span> <span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">Word8</span> <span class="symbol">=</span> <span class="symbol">\</span>_<span class="symbol">.</span> <span class="type-name">BToW8</span> <span class="symbol">$</span> body ()
  %while body&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">IterResult</span> a <span class="symbol">=</span>
  <span class="type-name">Continue</span>
  <span class="type-name">Done</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: can we improve effect inference so we don&#39;t need this?
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> liftState (ref<span class="symbol">:</span> <span class="type-name">Ref</span> h c) (f<span class="command">:a</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} b) (x<span class="command">:a</span>) <span class="symbol">:</span> {<span class="type-name">State</span> h<span class="symbol">|</span>eff} b <span class="symbol">=</span>
  f x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- A little iteration combinator
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> iter (body<span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">IterResult</span> a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} a  <span class="symbol">=</span>
  result <span class="symbol">=</span> yieldState <span class="type-name">Nothing</span> <span class="symbol">\</span>resultRef<span class="symbol">.</span> withState 0 <span class="symbol">\</span>i<span class="symbol">.</span>
    while <span class="keyword">do</span>
      continue <span class="symbol">=</span> isNothing <span class="symbol">$</span> get resultRef
      <span class="keyword">if</span> continue <span class="keyword">then</span>
        <span class="keyword">case</span> liftState resultRef (liftState i body) (get i) <span class="keyword">of</span>
          <span class="type-name">Continue</span> <span class="symbol">-&gt;</span> i <span class="symbol">:=</span> get i <span class="symbol">+</span> 1
          <span class="type-name">Done</span> result <span class="symbol">-&gt;</span> resultRef <span class="symbol">:=</span> <span class="type-name">Just</span> result
      continue

  <span class="keyword">case</span> result <span class="keyword">of</span>
    <span class="type-name">Just</span> ans <span class="symbol">-&gt;</span> ans
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> unreachable ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> boundedIter (maxIters<span class="symbol">:</span><span class="type-name">Int</span>) (fallback<span class="command">:a</span>)
  (body<span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">-&gt;</span> {<span class="symbol">|</span>eff} <span class="type-name">IterResult</span> a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} a  <span class="symbol">=</span>
  iter <span class="symbol">\</span>i<span class="symbol">.</span>
    <span class="keyword">if</span> i <span class="symbol">&gt;=</span> maxIters
      <span class="keyword">then</span> <span class="type-name">Done</span> fallback
      <span class="keyword">else</span> body i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Environment Variables</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fromCString (s<span class="symbol">:</span><span class="type-name">CString</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} (<span class="type-name">Maybe</span> <span class="type-name">String</span>) <span class="symbol">=</span>
  <span class="keyword">case</span> cStringPtr s <span class="keyword">of</span>
    <span class="type-name">Nothing</span> <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">Just</span> ptr <span class="symbol">-&gt;</span>
      <span class="type-name">Just</span> <span class="symbol">$</span> withDynamicBuffer <span class="symbol">\</span>buf<span class="symbol">.</span> iter <span class="symbol">\</span>i<span class="symbol">.</span>
        c <span class="symbol">=</span> load <span class="symbol">$</span> ptr <span class="symbol">+&gt;&gt;</span> i
        <span class="keyword">if</span> c <span class="symbol">==</span> &#39;<span class="symbol">\</span><span class="type-name">NUL</span>&#39;
          <span class="keyword">then</span> <span class="type-name">Done</span> <span class="symbol">$</span> loadDynBuffer buf
          <span class="keyword">else</span>
            pushDynBuffer buf c
            <span class="type-name">Continue</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> getEnv (name<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Maybe</span> <span class="type-name">String</span> <span class="symbol">=</span>
  withCString name <span class="symbol">\</span>(<span class="type-name">MkCString</span> ptr)<span class="symbol">.</span>
    fromCString <span class="symbol">$</span> <span class="type-name">MkCString</span> <span class="symbol">$</span> %ffi getenv <span class="type-name">RawPtr</span> ptr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> checkEnv (name<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Bool</span> <span class="symbol">=</span>
  isJust <span class="symbol">$</span> getEnv name
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>More Stream IO</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fread (stream<span class="symbol">:</span><span class="type-name">Stream</span> <span class="type-name">ReadMode</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">String</span> <span class="symbol">=</span>
  (<span class="type-name">MkStream</span> stream&#39;) <span class="symbol">=</span> stream
  <span class="comment">-- TODO: allow reading longer files!
</span>  n <span class="symbol">=</span> 4096
  withAlloc n <span class="symbol">\</span>ptr<span class="symbol">:</span>(<span class="type-name">Ptr</span> <span class="type-name">Char</span>)<span class="symbol">.</span>
    withDynamicBuffer <span class="symbol">\</span>buf<span class="symbol">.</span>
      iter <span class="symbol">\</span>_<span class="symbol">.</span>
        (<span class="type-name">MkPtr</span> rawPtr) <span class="symbol">=</span> ptr
        numRead <span class="symbol">=</span> <span class="type-name">I64ToI</span> <span class="symbol">$</span> %ffi fread <span class="type-name">Int64</span> rawPtr (<span class="type-name">IToI64</span> 1) (<span class="type-name">IToI64</span> n) stream&#39;
        extendDynBuffer buf <span class="symbol">$</span> stringFromCharPtr numRead ptr
        <span class="keyword">if</span> numRead <span class="symbol">==</span> n
          <span class="keyword">then</span> <span class="type-name">Continue</span>
          <span class="keyword">else</span> <span class="type-name">Done</span> ()
      loadDynBuffer buf
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Print</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> getOutputStream (_<span class="symbol">:</span><span class="type-name">Unit</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Stream</span> <span class="type-name">WriteMode</span> <span class="symbol">=</span>
  <span class="type-name">MkStream</span> <span class="symbol">$</span> %ptrLoad %outputStreamPtr
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> print (s<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  fwrite (getOutputStream ()) (s <span class="symbol">&lt;&gt;</span> &quot;<span class="symbol">\</span>n&quot;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Shelling Out</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> shellOut (command<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">String</span> <span class="symbol">=</span>
  modeStr <span class="symbol">=</span> &quot;r&quot;
  withCString command <span class="symbol">\</span>(<span class="type-name">MkCString</span> commandPtr)<span class="symbol">.</span>
    withCString modeStr <span class="symbol">\</span>(<span class="type-name">MkCString</span> modePtr)<span class="symbol">.</span>
      pipe <span class="symbol">=</span> <span class="type-name">MkStream</span> %ffi popen <span class="type-name">RawPtr</span> commandPtr modePtr
      fread pipe
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Partial functions</h2>
<p>A partial function in this context is a function that can error.
i.e. a function that is not actually defined for all of its supposed domain.
Not to be confused with a partially applied function</p>
</div></div><div class="cell"><div class="prose-block"><h3>Error throwing</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> error (s<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> a <span class="symbol">=</span> unsafeIO <span class="keyword">do</span>
  print s
  %throwError a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> todo <span class="symbol">:</span> a <span class="symbol">=</span> error &quot;<span class="type-name">TODO</span><span class="symbol">:</span> implement it<span class="symbol">!</span>&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>File Operations</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> deleteFile (f<span class="symbol">:</span><span class="type-name">FilePath</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  withCString f <span class="symbol">\</span>(<span class="type-name">MkCString</span> ptr)<span class="symbol">.</span>
    %ffi remove <span class="type-name">Int64</span> ptr
  ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withFile (f<span class="symbol">:</span><span class="type-name">FilePath</span>) (mode<span class="symbol">:</span><span class="type-name">StreamMode</span>)
      (action<span class="symbol">:</span> <span class="type-name">Stream</span> mode <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a)
      <span class="symbol">:</span> {<span class="type-name">IO</span>} a <span class="symbol">=</span>
  stream <span class="symbol">=</span> fopen f mode
  (<span class="type-name">MkStream</span> stream&#39;) <span class="symbol">=</span> stream
  <span class="keyword">if</span> stream&#39; <span class="symbol">==</span> nullRawPtr
    <span class="keyword">then</span>
      error <span class="symbol">$</span> &quot;<span class="type-name">Unable</span> to open file<span class="symbol">:</span> &quot; <span class="symbol">&lt;&gt;</span> f
    <span class="keyword">else</span>
      result <span class="symbol">=</span> action stream
      fclose stream
      result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> writeFile (f<span class="symbol">:</span><span class="type-name">FilePath</span>) (s<span class="symbol">:</span><span class="type-name">String</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  withFile f <span class="type-name">WriteMode</span> <span class="symbol">\</span>stream<span class="symbol">.</span> fwrite stream s
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> readFile (f<span class="symbol">:</span><span class="type-name">FilePath</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">String</span> <span class="symbol">=</span>
  withFile f <span class="type-name">ReadMode</span> <span class="symbol">\</span>stream<span class="symbol">.</span> fread stream
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> hasFile (f<span class="symbol">:</span><span class="type-name">FilePath</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">Bool</span> <span class="symbol">=</span>
  stream <span class="symbol">=</span> fopen f <span class="type-name">ReadMode</span>
  (<span class="type-name">MkStream</span> stream&#39;) <span class="symbol">=</span> stream
  result <span class="symbol">=</span> stream&#39; <span class="symbol">/=</span> nullRawPtr
  <span class="keyword">if</span> result <span class="keyword">then</span> fclose stream
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Temporary Files</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> newTempFile (_<span class="symbol">:</span><span class="type-name">Unit</span>) <span class="symbol">:</span> {<span class="type-name">IO</span>} <span class="type-name">FilePath</span> <span class="symbol">=</span>
  withCString &quot;<span class="symbol">/</span>tmp<span class="symbol">/</span>dex<span class="symbol">-</span><span class="type-name">XXXXXX</span>&quot; <span class="symbol">\</span>(<span class="type-name">MkCString</span> ptr)<span class="symbol">.</span>
    fd <span class="symbol">=</span> %ffi mkstemp <span class="type-name">Int32</span> ptr
    %ffi close <span class="type-name">Int32</span> fd
    stringFromCharPtr 15 (<span class="type-name">MkPtr</span> ptr)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withTempFile (action<span class="symbol">:</span> <span class="type-name">FilePath</span> <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a) <span class="symbol">:</span> {<span class="type-name">IO</span>} a <span class="symbol">=</span>
  tmpFile <span class="symbol">=</span> newTempFile ()
  result <span class="symbol">=</span> action tmpFile
  deleteFile tmpFile
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> withTempFiles (action<span class="symbol">:</span> (n<span class="symbol">=&gt;</span><span class="type-name">FilePath</span>) <span class="symbol">-&gt;</span> {<span class="type-name">IO</span>} a) <span class="symbol">:</span> {<span class="type-name">IO</span>} a <span class="symbol">=</span>
  tmpFiles <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> newTempFile ()
  result <span class="symbol">=</span> action tmpFiles
  <span class="keyword">for</span> i<span class="symbol">.</span> deleteFile tmpFiles<span class="symbol">.</span>i
  result
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Table operations</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fromOrdinal (n<span class="symbol">:</span><span class="type-name">Type</span>) (i<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  <span class="keyword">case</span> (0 <span class="symbol">&lt;=</span> i) <span class="symbol">&amp;&amp;</span> (i <span class="symbol">&lt;</span> size n) <span class="keyword">of</span>
    <span class="type-name">True</span>  <span class="symbol">-&gt;</span> unsafeFromOrdinal _ i
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> error <span class="symbol">$</span>
      &quot;<span class="type-name">Ordinal</span> index out <span class="keyword">of</span> range<span class="symbol">:</span>&quot; <span class="symbol">&lt;&gt;</span> show i <span class="symbol">&lt;&gt;</span> &quot; <span class="symbol">&gt;=</span> &quot; <span class="symbol">&lt;&gt;</span> show (size n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: could make an `unsafeCastIndex` and this could avoid the runtime copy
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: safe (runtime-checked) and unsafe versions
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> castTable (m<span class="symbol">:</span><span class="type-name">Type</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">case</span> size m <span class="symbol">==</span> size n <span class="keyword">of</span>
     <span class="type-name">True</span>  <span class="symbol">-&gt;</span> unsafeCastTable _ xs
     <span class="type-name">False</span> <span class="symbol">-&gt;</span> error <span class="symbol">$</span>
       &quot;<span class="type-name">Table</span> size mismatch in cast<span class="symbol">:</span> &quot; <span class="symbol">&lt;&gt;</span> show (size m) <span class="symbol">&lt;&gt;</span> &quot; vs &quot; <span class="symbol">&lt;&gt;</span> show (size n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> asidx (i<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> n <span class="symbol">=</span> fromOrdinal n i
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> (<span class="symbol">@</span>) (i<span class="symbol">:</span><span class="type-name">Int</span>) (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> n <span class="symbol">=</span> fromOrdinal n i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> slice (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (start<span class="symbol">:</span><span class="type-name">Int</span>) (m<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> xs<span class="symbol">.</span>(fromOrdinal _ (ordinal i <span class="symbol">+</span> start))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> head (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span> xs<span class="symbol">.</span>(0<span class="symbol">@</span>_)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> tail (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (start<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  numElts <span class="symbol">=</span> size n <span class="symbol">-</span> start
  toList <span class="symbol">$</span> slice xs start (<span class="type-name">Fin</span> numElts)
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><h2>Pseudorandom number generator utilities</h2>
<p>Dex does not use a stateful random number generator.
Rather it uses what is known as a split-able random number generator, which is based on a hash function.
Dex's PRNG system is modelled directly after <a href="https://github.com/google/jax/blob/master/design_notes/prng.md">JAX's</a>, which is based on a well established but shockingly underused idea from the functional programming community: the splittable PRNG. It's a good idea for many reasons, but it's especially helpful in a parallel setting. If you want to read more, <a href="http://publications.lib.chalmers.se/records/fulltext/183348/local_183348.pdf">Splittable pseudorandom number generators using cryptographic hashing</a> describes the splitting model itself and <a href="http://www.thesalmons.org/john/random123/papers/random123sc11.pdf">D.E. Shaw Research's counter-based PRNG</a> proposes the particular hash function we use.</p>
</div></div><div class="cell"><div class="prose-block"><h3>Key functions</h3>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: newtype
</span></div></div><div class="cell"><div class="code-block"><span class="type-name">Key</span> <span class="symbol">=</span> <span class="type-name">Word64</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> threeFry2x32 (k<span class="symbol">:</span><span class="type-name">Word64</span>) (count<span class="symbol">:</span><span class="type-name">Word64</span>) <span class="symbol">:</span> <span class="type-name">Word64</span> <span class="symbol">=</span>
  <span class="comment">-- Based on jax&#39;s threefry_2x32 by Matt Johnson and Peter Hawkins
</span>  rotations1 <span class="symbol">=</span> [13<span class="symbol">,</span> 15<span class="symbol">,</span> 26<span class="symbol">,</span> 6]
  rotations2 <span class="symbol">=</span> [17<span class="symbol">,</span> 29<span class="symbol">,</span> 16<span class="symbol">,</span> 24]

  k0 <span class="symbol">=</span> lowWord k
  k1 <span class="symbol">=</span> highWord k
  <span class="comment">-- TODO: add a fromHex
</span>  k2 <span class="symbol">=</span> k0 <span class="symbol">.^.</span> k1 <span class="symbol">.^.</span> (<span class="type-name">IToW32</span> 466688986) <span class="comment">-- 0x1BD11BDA
</span>
  x <span class="symbol">=</span> lowWord count
  y <span class="symbol">=</span> highWord count
  x <span class="symbol">=</span> x <span class="symbol">+</span> k0
  y <span class="symbol">=</span> y <span class="symbol">+</span> k1

  rotations <span class="symbol">=</span> [rotations1<span class="symbol">,</span> rotations2]
  ks <span class="symbol">=</span> [k1<span class="symbol">,</span> k2<span class="symbol">,</span> k0]
  (x<span class="symbol">,</span> y) <span class="symbol">=</span> yieldState (x<span class="symbol">,</span> y) <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> 5)<span class="symbol">.</span>
    <span class="keyword">for</span> j<span class="symbol">.</span>
      (x<span class="symbol">,</span> y) <span class="symbol">=</span> get ref
      rotationIndex <span class="symbol">=</span> unsafeFromOrdinal _ (mod (ordinal i) 2)
      rot <span class="symbol">=</span> rotations<span class="symbol">.</span>rotationIndex<span class="symbol">.</span>j
      x <span class="symbol">=</span> x <span class="symbol">+</span> y
      y <span class="symbol">=</span> (y <span class="symbol">.&lt;&lt;.</span> rot) <span class="symbol">.|.</span> (y <span class="symbol">.&gt;&gt;.</span> (32 <span class="symbol">-</span> rot))
      y <span class="symbol">=</span> x <span class="symbol">.^.</span> y
      ref <span class="symbol">:=</span> (x<span class="symbol">,</span> y)
    (x<span class="symbol">,</span> y) <span class="symbol">=</span> get ref
    x <span class="symbol">=</span> x <span class="symbol">+</span> ks<span class="symbol">.</span>(unsafeFromOrdinal _ (mod (ordinal i) 3))
    y <span class="symbol">=</span> y <span class="symbol">+</span> ks<span class="symbol">.</span>(unsafeFromOrdinal _ (mod ((ordinal i)<span class="symbol">+</span>1) 3)) <span class="symbol">+</span> <span class="type-name">IToW32</span> ((ordinal i)<span class="symbol">+</span>1)
    ref <span class="symbol">:=</span> (x<span class="symbol">,</span> y)

  (<span class="type-name">W32ToW64</span> x <span class="symbol">.&lt;&lt;.</span> 32) <span class="symbol">.|.</span> (<span class="type-name">W32ToW64</span> y)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> hash (x<span class="symbol">:</span><span class="type-name">Key</span>) (y<span class="symbol">:</span><span class="type-name">Int32</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span>
  y64 <span class="symbol">=</span> <span class="type-name">IToW64</span> y
  threeFry2x32 x y64
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> newKey (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span> hash (<span class="type-name">IToW64</span> 0) x
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> many (f<span class="symbol">:</span><span class="type-name">Key</span><span class="symbol">-&gt;</span>a) (k<span class="symbol">:</span><span class="type-name">Key</span>) (i<span class="command">:n</span>) <span class="symbol">:</span> a <span class="symbol">=</span> f (hash k (ordinal i))
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ixkey (k<span class="symbol">:</span><span class="type-name">Key</span>) (i<span class="command">:n</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span> hash k (ordinal i)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> ixkey2 (k<span class="symbol">:</span><span class="type-name">Key</span>) (i<span class="command">:n</span>) (j<span class="command">:m</span>) <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">=</span> hash (hash k (ordinal i)) (ordinal j)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> splitKey (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> <span class="type-name">Key</span> <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> ixkey k i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>Sample Generators</h3>
<p>These functions generate samples taken from, different distributions.
Such as <code>randMat</code> with samples from the distribution of floating point matrices where each element is taken from a i.i.d. uniform distribution.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> rand (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>  unsafeIO <span class="keyword">do</span> <span class="type-name">F64ToF</span> <span class="symbol">$</span> %ffi randunif <span class="type-name">Float64</span> k
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randVec (n<span class="symbol">:</span><span class="type-name">Int</span>) (f<span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">-&gt;</span> a) (k<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> n)<span class="symbol">.</span> f (ixkey k i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randMat (n<span class="symbol">:</span><span class="type-name">Int</span>) (m<span class="symbol">:</span><span class="type-name">Int</span>) (f<span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">-&gt;</span> a) (k<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Fin</span> n <span class="symbol">=&gt;</span> <span class="type-name">Fin</span> m <span class="symbol">=&gt;</span> a <span class="symbol">=</span>
  <span class="keyword">for</span> i j<span class="symbol">.</span> f (ixkey2 k i j)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randn (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  [k1<span class="symbol">,</span> k2] <span class="symbol">=</span> splitKey k
  u1 <span class="symbol">=</span> rand k1
  u2 <span class="symbol">=</span> rand k2
  sqrt ((<span class="symbol">-</span>2<span class="symbol">.</span>0) <span class="symbol">*</span> log u1) <span class="symbol">*</span> cos (2<span class="symbol">.</span>0 <span class="symbol">*</span> pi <span class="symbol">*</span> u2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: Make this better...
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randInt (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> (internalCast <span class="type-name">Int</span> k) `mod` 2147483647
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> bern (p<span class="symbol">:</span><span class="type-name">Float</span>) (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> rand k <span class="symbol">&lt;</span> p
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randnVec (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> randn (ixkey k i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> randIdx (k<span class="symbol">:</span><span class="type-name">Key</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  unif <span class="symbol">=</span> rand k
  fromOrdinal n <span class="symbol">$</span> <span class="type-name">FToI</span> <span class="symbol">$</span> floor <span class="symbol">$</span> unif <span class="symbol">*</span> <span class="type-name">IToF</span> (size n)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Arbitrary</h2>
<p>Type class for generating example values</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">interface</span> <span class="type-name">Arbitrary</span> a
  arb <span class="symbol">:</span> <span class="type-name">Key</span> <span class="symbol">-&gt;</span> a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> <span class="type-name">Float32</span>
  arb <span class="symbol">=</span> randn
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> <span class="type-name">Int32</span>
  arb <span class="symbol">=</span> <span class="symbol">\</span>key<span class="symbol">.</span> <span class="type-name">FToI</span> <span class="symbol">$</span> randn key <span class="symbol">*</span> 5<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Arbitrary</span> a] <span class="type-name">Arbitrary</span> (n<span class="symbol">=&gt;</span>a)
  arb <span class="symbol">=</span> <span class="symbol">\</span>key<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span> arb <span class="symbol">$</span> ixkey key i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> [<span class="type-name">Arbitrary</span> a<span class="symbol">,</span> <span class="type-name">Arbitrary</span> b] <span class="type-name">Arbitrary</span> (a <span class="symbol">&amp;</span> b)
  arb <span class="symbol">=</span> <span class="symbol">\</span>key<span class="symbol">.</span>
      [k1<span class="symbol">,</span> k2] <span class="symbol">=</span> splitKey key
      (arb k1<span class="symbol">,</span> arb k2)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Arbitrary</span> (<span class="type-name">Fin</span> n)
  arb <span class="symbol">=</span> randIdx
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Ord on Arrays</h2>
</div></div><div class="cell"><div class="prose-block"><h3>Searching</h3>
</div></div><div class="cell"><div class="prose-block"><p>returns the highest index <code>i</code> such that <code>xs.i &lt;= x</code></p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> searchSorted [<span class="type-name">Ord</span> a] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (x<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> n <span class="symbol">=</span>
  <span class="keyword">if</span> size n <span class="symbol">==</span> 0
    <span class="keyword">then</span> <span class="type-name">Nothing</span>
    <span class="keyword">else</span> <span class="keyword">if</span> x <span class="symbol">&lt;</span> xs<span class="symbol">.</span>(fromOrdinal _ 0)
      <span class="keyword">then</span> <span class="type-name">Nothing</span>
      <span class="keyword">else</span> withState 0 <span class="symbol">\</span>low<span class="symbol">.</span> withState (size n) <span class="symbol">\</span>high<span class="symbol">.</span> iter <span class="symbol">\</span>_<span class="symbol">.</span>
        numLeft <span class="symbol">=</span> get high <span class="symbol">-</span> get low
        <span class="keyword">if</span> numLeft <span class="symbol">==</span> 1
          <span class="keyword">then</span> <span class="type-name">Done</span> <span class="symbol">$</span> <span class="type-name">Just</span> <span class="symbol">$</span> fromOrdinal _ <span class="symbol">$</span> get low
          <span class="keyword">else</span>
            centerIx <span class="symbol">=</span> get low <span class="symbol">+</span> idiv numLeft 2
            <span class="keyword">if</span> x <span class="symbol">&lt;</span> xs<span class="symbol">.</span>(fromOrdinal _ centerIx)
              <span class="keyword">then</span> high <span class="symbol">:=</span> centerIx
              <span class="keyword">else</span> low  <span class="symbol">:=</span> centerIx
            <span class="type-name">Continue</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>min / max etc</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minBy [<span class="type-name">Ord</span> o] (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> select (f x <span class="symbol">&lt;</span> f y) x y
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maxBy [<span class="type-name">Ord</span> o] (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span> select (f x <span class="symbol">&gt;</span> f y) x y
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> min [<span class="type-name">Ord</span> o] (x1<span class="symbol">:</span> o) <span class="symbol">-&gt;</span> (x2<span class="symbol">:</span> o) <span class="symbol">:</span> o <span class="symbol">=</span> minBy id x1 x2
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> max [<span class="type-name">Ord</span> o] (x1<span class="symbol">:</span> o) <span class="symbol">-&gt;</span> (x2<span class="symbol">:</span> o) <span class="symbol">:</span> o <span class="symbol">=</span> maxBy id x1 x2
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minimumBy [<span class="type-name">Ord</span> o] (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span>
  reduce xs<span class="symbol">.</span>(0<span class="symbol">@</span>_) (minBy f) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maximumBy [<span class="type-name">Ord</span> o] (f<span class="command">:a</span><span class="symbol">-&gt;</span>o) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> a <span class="symbol">=</span>
  reduce xs<span class="symbol">.</span>(0<span class="symbol">@</span>_) (maxBy f) xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> minimum [<span class="type-name">Ord</span> o] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> o <span class="symbol">=</span> minimumBy id xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> maximum [<span class="type-name">Ord</span> o] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> o <span class="symbol">=</span> maximumBy id xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>argmin/argmax</h3>
<p>TODO: put in same section as <code>searchsorted</code></p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> argscan (comp<span class="command">:o</span><span class="symbol">-&gt;</span>o<span class="symbol">-&gt;</span><span class="type-name">Bool</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> n <span class="symbol">=</span>
  zeroth <span class="symbol">=</span> (0<span class="symbol">@</span>_<span class="symbol">,</span> xs<span class="symbol">.</span>(0<span class="symbol">@</span>_))
  compare <span class="symbol">=</span> <span class="symbol">\</span>(idx1<span class="symbol">,</span> x1) (idx2<span class="symbol">,</span> x2)<span class="symbol">.</span>
    select (comp x1 x2) (idx1<span class="symbol">,</span> x1) (idx2<span class="symbol">,</span> x2)
  zipped <span class="symbol">=</span> <span class="keyword">for</span> i<span class="symbol">.</span> (i<span class="symbol">,</span> xs<span class="symbol">.</span>i)
  fst <span class="symbol">$</span> reduce zeroth compare zipped
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> argmin [<span class="type-name">Ord</span> o] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> n <span class="symbol">=</span> argscan (<span class="symbol">&lt;</span>) xs
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> argmax [<span class="type-name">Ord</span> o] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>o) <span class="symbol">:</span> n <span class="symbol">=</span> argscan (<span class="symbol">&gt;</span>) xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h3>clip</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> clip [<span class="type-name">Ord</span> a] ((low<span class="symbol">,</span>high)<span class="symbol">:</span>(a<span class="symbol">&amp;</span>a)) (x<span class="command">:a</span>) <span class="symbol">:</span> a <span class="symbol">=</span>
  min high <span class="symbol">$</span> max low x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Trigonometric functions</h2>
<p>TODO: these should be with the other Elementary/Special Functions</p>
<h3>atan/atan2</h3>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> atan_inner (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="comment">-- From &quot;Computing accurate Horner form approximations to
</span>  <span class="comment">-- special functions in finite precision arithmetic&quot;
</span>  <span class="comment">-- https://arxiv.org/abs/1508.03211
</span>  <span class="comment">-- Only accurate in the range [-1, 1]
</span>  s <span class="symbol">=</span> x <span class="symbol">*</span> x
  r <span class="symbol">=</span> 0<span class="symbol">.</span>0027856871
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>0158660002
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">+</span> 0<span class="symbol">.</span>042472221
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>0749753043
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">+</span> 0<span class="symbol">.</span>106448799
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>142070308
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">+</span> 0<span class="symbol">.</span>199934542
  r <span class="symbol">=</span> r <span class="symbol">*</span> s <span class="symbol">-</span> 0<span class="symbol">.</span>333331466
  r <span class="symbol">=</span> r <span class="symbol">*</span> s
  r <span class="symbol">*</span> x <span class="symbol">+</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> min_and_max [<span class="type-name">Ord</span> a] (x<span class="command">:a</span>) (y<span class="command">:a</span>) <span class="symbol">:</span> (a <span class="symbol">&amp;</span> a) <span class="symbol">=</span>
  select (x <span class="symbol">&lt;</span> y) (x<span class="symbol">,</span> y) (y<span class="symbol">,</span> x)  <span class="comment">-- get both with one comparison.
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> atan2 (y<span class="symbol">:</span><span class="type-name">Float</span>) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  <span class="comment">-- Based off of the Tensorflow implementation at
</span>  <span class="comment">-- github.com/tensorflow/mlir-hlo/blob/master/lib/
</span>  <span class="comment">-- Dialect/mhlo/transforms/legalize_trigonometric_to_approximation.cc#L147
</span>  <span class="comment">-- With a fix to the nan propagation.
</span>  abs_x <span class="symbol">=</span> abs x
  abs_y <span class="symbol">=</span> abs y
  (min_abs_x_y<span class="symbol">,</span> max_abs_x_y) <span class="symbol">=</span> min_and_max abs_x abs_y
  a <span class="symbol">=</span> atan_inner (min_abs_x_y <span class="symbol">/</span> max_abs_x_y)
  a <span class="symbol">=</span> select (abs_x <span class="symbol">&lt;=</span> abs_y) ((pi <span class="symbol">/</span> 2<span class="symbol">.</span>0) <span class="symbol">-</span>a) a
  a <span class="symbol">=</span> select (x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0) (pi <span class="symbol">-</span> a) a
  t <span class="symbol">=</span> select (x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0) pi 0<span class="symbol">.</span>0
  a <span class="symbol">=</span> select (y <span class="symbol">==</span> 0<span class="symbol">.</span>0) t a
  t <span class="symbol">=</span> select (x <span class="symbol">&lt;</span> 0<span class="symbol">.</span>0) (3<span class="symbol">.</span>0 <span class="symbol">*</span> pi <span class="symbol">/</span> 4<span class="symbol">.</span>0) (pi <span class="symbol">/</span> 4<span class="symbol">.</span>0)
  a <span class="symbol">=</span> select (isinf x <span class="symbol">&amp;&amp;</span> isinf y) t a  <span class="comment">-- Handle infinite inputs.
</span>  a <span class="symbol">=</span> copysign a y
  select (either_is_nan x y) nan a  <span class="comment">-- Propagate NaNs.
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> atan (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> atan2 x 1<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Complex numbers</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">data</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="type-name">MkComplex</span> <span class="type-name">Float</span> <span class="type-name">Float</span>  <span class="comment">-- real, imaginary
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasAllClose</span> <span class="type-name">Complex</span>
  allclose <span class="symbol">=</span> <span class="symbol">\</span>atol rtol (<span class="type-name">MkComplex</span> a b) (<span class="type-name">MkComplex</span> c d)<span class="symbol">.</span> (a <span class="symbol">~~</span> c) <span class="symbol">&amp;&amp;</span> (b <span class="symbol">~~</span> d)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">HasDefaultTolerance</span> <span class="type-name">Complex</span>
  atol <span class="symbol">=</span> <span class="type-name">MkComplex</span> atol atol
  rtol <span class="symbol">=</span> <span class="type-name">MkComplex</span> rtol rtol
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Eq</span> <span class="type-name">Complex</span>
  (<span class="symbol">==</span>) <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkComplex</span> a b) (<span class="type-name">MkComplex</span> c d)<span class="symbol">.</span> (a <span class="symbol">==</span> c) <span class="symbol">&amp;&amp;</span> (b <span class="symbol">==</span> d)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Add</span> <span class="type-name">Complex</span>
  add <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkComplex</span> a b) (<span class="type-name">MkComplex</span> c d)<span class="symbol">.</span> <span class="type-name">MkComplex</span> (a <span class="symbol">+</span> c) (b <span class="symbol">+</span> d)
  sub <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkComplex</span> a b) (<span class="type-name">MkComplex</span> c d)<span class="symbol">.</span> <span class="type-name">MkComplex</span> (a <span class="symbol">-</span> c) (b <span class="symbol">-</span> d)
  zero <span class="symbol">=</span> <span class="type-name">MkComplex</span> 0<span class="symbol">.</span>0 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Mul</span> <span class="type-name">Complex</span>
  mul <span class="symbol">=</span> <span class="symbol">\</span>(<span class="type-name">MkComplex</span> a b) (<span class="type-name">MkComplex</span> c d)<span class="symbol">.</span>
    <span class="type-name">MkComplex</span> (a <span class="symbol">*</span> c <span class="symbol">-</span> b <span class="symbol">*</span> d) (a <span class="symbol">*</span> d <span class="symbol">+</span> b <span class="symbol">*</span> c)
  one <span class="symbol">=</span> <span class="type-name">MkComplex</span> 1<span class="symbol">.</span>0 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">VSpace</span> <span class="type-name">Complex</span>
  scaleVec <span class="symbol">=</span> <span class="symbol">\</span>a<span class="symbol">:</span><span class="type-name">Float</span> (<span class="type-name">MkComplex</span> c d)<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> <span class="type-name">MkComplex</span> (a <span class="symbol">*</span> c) (a <span class="symbol">*</span> d)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- Todo: Hook up to (/) operator.  Might require two-parameter VSpace.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_division (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) (<span class="type-name">MkComplex</span> c d<span class="symbol">:</span><span class="type-name">Complex</span>)<span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  <span class="type-name">MkComplex</span> ((a <span class="symbol">*</span> c <span class="symbol">+</span> b <span class="symbol">*</span> d) <span class="symbol">/</span> (c <span class="symbol">*</span> c <span class="symbol">+</span> d <span class="symbol">*</span> d)) ((b <span class="symbol">*</span> c <span class="symbol">-</span> a <span class="symbol">*</span> d) <span class="symbol">/</span> (c <span class="symbol">*</span> c <span class="symbol">+</span> d <span class="symbol">*</span> d))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_exp (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  expx <span class="symbol">=</span> exp a
  <span class="type-name">MkComplex</span> (expx <span class="symbol">*</span> cos b) (expx <span class="symbol">*</span> sin b)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_exp2 (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  exp2x <span class="symbol">=</span> exp2 a
  b&#39; <span class="symbol">=</span> b <span class="symbol">*</span> log 2<span class="symbol">.</span>0
  <span class="type-name">MkComplex</span> (exp2x <span class="symbol">*</span> cos b&#39;) (exp2x <span class="symbol">*</span> sin b&#39;)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_conj (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="type-name">MkComplex</span> a (<span class="symbol">-</span>b)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_abs  (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> a <span class="symbol">*</span> a <span class="symbol">+</span> b <span class="symbol">*</span> b
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_mag  (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> sqrt (a <span class="symbol">*</span> a <span class="symbol">+</span> b <span class="symbol">*</span> b)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_arg  (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span> atan2 b a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">complex_log   <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> <span class="type-name">MkComplex</span> (log (complex_mag x)) (complex_arg x)
</div></div><div class="cell"><div class="code-block">complex_log2  <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> (complex_log x) <span class="symbol">/</span> log 2<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">complex_log10 <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> (complex_log x) <span class="symbol">/</span> log 10<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">complex_pow <span class="symbol">=</span> <span class="symbol">\</span>base<span class="symbol">:</span><span class="type-name">Complex</span> power<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> complex_exp (power <span class="symbol">*</span> complex_log base)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_sqrt (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  m <span class="symbol">=</span> complex_mag <span class="symbol">$</span> <span class="type-name">MkComplex</span> a b
  <span class="type-name">MkComplex</span> (sqrt ((a <span class="symbol">+</span> m) <span class="symbol">/</span> 2<span class="symbol">.</span>0)) (sign b <span class="symbol">*</span> sqrt ((m <span class="symbol">-</span> a) <span class="symbol">/</span> 2<span class="symbol">.</span>0))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_sin  (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="type-name">MkComplex</span> (sin  a <span class="symbol">*</span> cosh b) (cos   a <span class="symbol">*</span> sinh b)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_sinh (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="type-name">MkComplex</span> (sinh a <span class="symbol">*</span>  cos b) (cosh  a <span class="symbol">*</span> sin  b)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_cos  (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="type-name">MkComplex</span> (cos  a <span class="symbol">*</span> cosh b) (<span class="symbol">-</span>sin  a <span class="symbol">*</span> sinh b)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_cosh (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="type-name">MkComplex</span> (cosh a <span class="symbol">*</span>  cos b) (<span class="symbol">-</span>sinh a <span class="symbol">*</span> sin  b)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_tan  (x<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span> complex_division (complex_sin  x) (complex_cos  x)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_tanh (<span class="type-name">MkComplex</span> a b<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  num <span class="symbol">=</span> <span class="type-name">MkComplex</span> (sinh a <span class="symbol">*</span> cos b) (cosh a <span class="symbol">*</span> sin  b)
  den <span class="symbol">=</span> <span class="type-name">MkComplex</span> (cosh a <span class="symbol">*</span> cos b) (sinh a <span class="symbol">*</span> sin  b)
  complex_division num den
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Fractional</span> <span class="type-name">Complex</span>
  divide <span class="symbol">=</span> complex_division
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_floor (<span class="type-name">MkComplex</span> re im<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  <span class="comment">-- from &quot;Complex Floor&quot; by Eugene McDonnell
</span>  <span class="comment">-- https://www.jsoftware.com/papers/eem/complexfloor.htm
</span>  fr <span class="symbol">=</span> floor re
  fi <span class="symbol">=</span> floor im
  x <span class="symbol">=</span> re <span class="symbol">-</span> fr
  y <span class="symbol">=</span> im <span class="symbol">-</span> fi
  <span class="keyword">case</span> (x <span class="symbol">+</span> y) <span class="symbol">&lt;</span> 1<span class="symbol">.</span>0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> <span class="type-name">MkComplex</span> fr fi
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="keyword">case</span> x <span class="symbol">&gt;=</span> y <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> <span class="type-name">MkComplex</span> (fr <span class="symbol">+</span> 1<span class="symbol">.</span>0) fi
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">MkComplex</span> fr (fi <span class="symbol">+</span> 1<span class="symbol">.</span>0)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">complex_ceil <span class="symbol">=</span>  <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> <span class="symbol">-</span>(complex_floor (<span class="symbol">-</span>x))
</div></div><div class="cell"><div class="code-block">complex_round <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span> complex_floor <span class="symbol">$</span> <span class="type-name">MkComplex</span> 0<span class="symbol">.</span>5 0<span class="symbol">.</span>0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block">complex_lgamma <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">-&gt;</span> <span class="type-name">Complex</span> <span class="symbol">=</span> <span class="symbol">\</span>x<span class="symbol">:</span><span class="type-name">Complex</span><span class="symbol">.</span>
  todo  <span class="comment">-- This one is pretty hairy.
</span></div></div><div class="cell"><div class="code-block">        <span class="comment">-- See https://cs.uwaterloo.ca/research/tr/1994/23/CS-94-23.pdf
</span></div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> complex_log1p (x<span class="symbol">:</span><span class="type-name">Complex</span>) <span class="symbol">:</span> <span class="type-name">Complex</span> <span class="symbol">=</span>
  (<span class="type-name">MkComplex</span> a b) <span class="symbol">=</span> x
  <span class="keyword">case</span> a <span class="symbol">==</span> 0<span class="symbol">.</span>0 <span class="keyword">of</span>
    <span class="type-name">True</span> <span class="symbol">-&gt;</span> x
    <span class="type-name">False</span> <span class="symbol">-&gt;</span>
      u <span class="symbol">=</span> x <span class="symbol">+</span> <span class="type-name">MkComplex</span> 1<span class="symbol">.</span>0 0<span class="symbol">.</span>0
      <span class="keyword">case</span> a <span class="symbol">&lt;=</span> <span class="symbol">-</span>1<span class="symbol">.</span>0 <span class="keyword">of</span>
        <span class="type-name">True</span> <span class="symbol">-&gt;</span> complex_log u
        <span class="type-name">False</span> <span class="symbol">-&gt;</span> divide ((complex_log u) <span class="symbol">*</span> x) x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">instance</span> <span class="type-name">Floating</span> <span class="type-name">Complex</span>
  exp    <span class="symbol">=</span> complex_exp
  exp2   <span class="symbol">=</span> complex_exp2
  log    <span class="symbol">=</span> complex_log
  log2   <span class="symbol">=</span> complex_log2
  log10  <span class="symbol">=</span> complex_log10
  log1p  <span class="symbol">=</span> complex_log1p
  sin    <span class="symbol">=</span> complex_sin
  cos    <span class="symbol">=</span> complex_cos
  tan    <span class="symbol">=</span> complex_tan
  sinh   <span class="symbol">=</span> complex_sinh
  cosh   <span class="symbol">=</span> complex_cosh
  tanh   <span class="symbol">=</span> complex_tanh
  floor  <span class="symbol">=</span> complex_floor
  ceil   <span class="symbol">=</span> complex_ceil
  round  <span class="symbol">=</span> complex_round
  sqrt   <span class="symbol">=</span> complex_sqrt
  pow    <span class="symbol">=</span> complex_pow
  lgamma <span class="symbol">=</span> complex_lgamma
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><h2>Miscellaneous utilities</h2>
<p>TODO: all of these should be in some other section</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reflect (i<span class="command">:n</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  unsafeFromOrdinal n ((size n) <span class="symbol">-</span> 1 <span class="symbol">-</span> ordinal i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> reverse (x<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> n<span class="symbol">=&gt;</span>a <span class="symbol">=</span>
  <span class="keyword">for</span> i<span class="symbol">.</span> x<span class="symbol">.</span>(reflect i)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> padTo (m<span class="symbol">:</span><span class="type-name">Type</span>) (x<span class="command">:a</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> (m<span class="symbol">=&gt;</span>a) <span class="symbol">=</span>
  n&#39; <span class="symbol">=</span> size n
  <span class="keyword">for</span> i<span class="symbol">.</span>
    i&#39; <span class="symbol">=</span> ordinal i
    <span class="keyword">case</span> i&#39; <span class="symbol">&lt;</span> n&#39; <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> xs<span class="symbol">.</span>(i&#39;<span class="symbol">@</span>_)
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> x
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> idivCeil (x<span class="symbol">:</span><span class="type-name">Int</span>) (y<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> idiv x y <span class="symbol">+</span> <span class="type-name">BToI</span> (rem x y <span class="symbol">/=</span> 0)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> intdiv2 (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %shr x (1 <span class="symbol">:</span> <span class="type-name">Int</span>)
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> intpow2 (power<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> %shl (1 <span class="symbol">:</span> <span class="type-name">Int</span>) power
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isOdd  (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> rem x 2 <span class="symbol">==</span> 1
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isEven (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> rem x 2 <span class="symbol">==</span> 0
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> isPowerOf2 (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span>
  <span class="comment">-- A fast trick based on bitwise AND.
</span>  <span class="comment">-- This works on integer types larger than 8 bits.
</span>  <span class="comment">-- Note: The bitwise and operator (.&amp;.)
</span>  <span class="comment">-- is only defined for Byte, which is why
</span>  <span class="comment">-- we use %and here. TODO: Make (.&amp;.) polymorphic.
</span>  <span class="keyword">if</span> x <span class="symbol">==</span> 0
    <span class="keyword">then</span> <span class="type-name">False</span>
    <span class="keyword">else</span> 0 <span class="symbol">==</span> %and x (x <span class="symbol">-</span> 1)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> intlog2 (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span>
  yieldState (<span class="symbol">-</span>1) <span class="symbol">\</span>ansRef<span class="symbol">.</span>
    runState 1 <span class="symbol">\</span>cmpRef<span class="symbol">.</span>
      while <span class="keyword">do</span>
        <span class="keyword">if</span> x <span class="symbol">&gt;=</span> (get cmpRef)
          <span class="keyword">then</span>
            ansRef <span class="symbol">:=</span> (get ansRef) <span class="symbol">+</span> 1
            cmpRef <span class="symbol">:=</span> %shl (get cmpRef) (1 <span class="symbol">:</span> <span class="type-name">Int</span>)
            <span class="type-name">True</span>
          <span class="keyword">else</span>
            <span class="type-name">False</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> nextpow2 (x<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> <span class="keyword">case</span> isPowerOf2 x <span class="keyword">of</span>
  <span class="type-name">True</span> <span class="symbol">-&gt;</span> x
  <span class="type-name">False</span> <span class="symbol">-&gt;</span> intpow2 (1 <span class="symbol">+</span> intlog2 x)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> generalIntegerPower (times<span class="command">:a</span><span class="symbol">-&gt;</span>a<span class="symbol">-&gt;</span>a) (one<span class="command">:a</span>) (base<span class="command">:a</span>) (power<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> a <span class="symbol">=</span>
  <span class="comment">-- Implements exponentiation by squaring.
</span>  <span class="comment">-- Todo: Make power a Nat when it&#39;s available.
</span>  <span class="comment">-- This could be nicer if there were a way to explicitly
</span>  <span class="comment">-- specify which typelcass instance to use for Mul.
</span>  yieldState one <span class="symbol">\</span>ans<span class="symbol">.</span>
    withState power <span class="symbol">\</span>pow<span class="symbol">.</span> withState base <span class="symbol">\</span>z<span class="symbol">.</span>
      while <span class="keyword">do</span>
        <span class="keyword">if</span> get pow <span class="symbol">&gt;</span> 0
          <span class="keyword">then</span>
            <span class="keyword">if</span> isOdd (get pow)
              <span class="keyword">then</span> ans <span class="symbol">:=</span> times (get ans) (get z)
            z <span class="symbol">:=</span> times (get z) (get z)
            pow <span class="symbol">:=</span> intdiv2 (get pow)
            <span class="type-name">True</span>
          <span class="keyword">else</span>
            <span class="type-name">False</span>
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> intpow [<span class="type-name">Mul</span> a] (base<span class="command">:a</span>) (power<span class="symbol">:</span><span class="type-name">Int</span>) <span class="symbol">:</span> a <span class="symbol">=</span>
  generalIntegerPower (<span class="symbol">*</span>) one base power
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> fromJust (x<span class="symbol">:</span><span class="type-name">Maybe</span> a) <span class="symbol">:</span> a <span class="symbol">=</span> <span class="keyword">case</span> x <span class="keyword">of</span> <span class="type-name">Just</span> x&#39; <span class="symbol">-&gt;</span> x&#39;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> anySat (f<span class="command">:a</span> <span class="symbol">-&gt;</span> <span class="type-name">Bool</span>) (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> any (map f xs)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> seqMaybes (n<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (a<span class="symbol">:</span><span class="type-name">Type</span>) <span class="symbol">?-&gt;</span> (xs <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Maybe</span> a) <span class="symbol">:</span> <span class="type-name">Maybe</span> (n <span class="symbol">=&gt;</span> a) <span class="symbol">=</span>
  <span class="comment">-- is it possible to implement this safely? (i.e. without using partial
</span>  <span class="comment">-- functions)
</span>  <span class="keyword">case</span> anySat isNothing xs <span class="keyword">of</span>
    <span class="type-name">True</span>  <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    <span class="type-name">False</span> <span class="symbol">-&gt;</span> <span class="type-name">Just</span> <span class="symbol">$</span> map fromJust xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> linearSearch [<span class="type-name">Eq</span> a] (xs<span class="command">:n</span><span class="symbol">=&gt;</span>a) (query<span class="command">:a</span>) <span class="symbol">:</span> <span class="type-name">Maybe</span> n <span class="symbol">=</span>
  yieldState <span class="type-name">Nothing</span> <span class="symbol">\</span>ref<span class="symbol">.</span> <span class="keyword">for</span> i<span class="symbol">.</span>
    <span class="keyword">case</span> xs<span class="symbol">.</span>i <span class="symbol">==</span> query <span class="keyword">of</span>
      <span class="type-name">True</span>  <span class="symbol">-&gt;</span> ref <span class="symbol">:=</span> <span class="type-name">Just</span> i
      <span class="type-name">False</span> <span class="symbol">-&gt;</span> ()
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> listLength ((<span class="type-name">AsList</span> n _)<span class="symbol">:</span><span class="type-name">List</span> a) <span class="symbol">:</span> <span class="type-name">Int</span> <span class="symbol">=</span> n
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- This is for efficiency (rather than using `&lt;&gt;` repeatedly)
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- TODO: we want this for any monoid but this implementation won&#39;t work.
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> concat (lists<span class="command">:n</span><span class="symbol">=&gt;</span>(<span class="type-name">List</span> a)) <span class="symbol">:</span> <span class="type-name">List</span> a <span class="symbol">=</span>
  totalSize <span class="symbol">=</span> sum <span class="keyword">for</span> i<span class="symbol">.</span> listLength lists<span class="symbol">.</span>i
  <span class="type-name">AsList</span> _ <span class="symbol">$</span> withState 0 <span class="symbol">\</span>listIdx<span class="symbol">.</span>
    withState 0 <span class="symbol">\</span>eltIdx<span class="symbol">.</span>
      <span class="keyword">for</span> i<span class="symbol">:</span>(<span class="type-name">Fin</span> totalSize)<span class="symbol">.</span>
        while <span class="keyword">do</span>
          continue <span class="symbol">=</span> get eltIdx <span class="symbol">&gt;=</span> listLength (lists<span class="symbol">.</span>((get listIdx)<span class="symbol">@</span>_))
          <span class="keyword">if</span> continue
            <span class="keyword">then</span>
              eltIdx <span class="symbol">:=</span> 0
              listIdx <span class="symbol">:=</span> get listIdx <span class="symbol">+</span> 1
            <span class="keyword">else</span> ()
          continue
        (<span class="type-name">AsList</span> _ xs) <span class="symbol">=</span> lists<span class="symbol">.</span>((get listIdx)<span class="symbol">@</span>_)
        eltIdxVal <span class="symbol">=</span> get eltIdx
        eltIdx <span class="symbol">:=</span> eltIdxVal <span class="symbol">+</span> 1
        xs<span class="symbol">.</span>(eltIdxVal<span class="symbol">@</span>_)
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Probability</h2>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cumSumLow (xs<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  withState 0<span class="symbol">.</span>0 <span class="symbol">\</span>total<span class="symbol">.</span>
    <span class="keyword">for</span> i<span class="symbol">.</span>
      oldTotal <span class="symbol">=</span> get total
      total <span class="symbol">:=</span> oldTotal <span class="symbol">+</span> xs<span class="symbol">.</span>i
      oldTotal
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- cdf should include 0.0 but not 1.0
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> categoricalFromCDF (cdf<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) (key<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  r <span class="symbol">=</span> rand key
  <span class="keyword">case</span> searchSorted cdf r <span class="keyword">of</span>
    <span class="type-name">Just</span> i <span class="symbol">-&gt;</span> i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> normalizePdf (xs<span class="symbol">:</span> d<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> d<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span> xs <span class="symbol">/</span> sum xs
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> cdfForCategorical (logprobs<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  maxLogProb <span class="symbol">=</span> maximum logprobs
  cumSumLow <span class="symbol">$</span> normalizePdf <span class="symbol">$</span> map exp <span class="symbol">$</span> <span class="keyword">for</span> i<span class="symbol">.</span> logprobs<span class="symbol">.</span>i <span class="symbol">-</span> maxLogProb
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> categorical (logprobs<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) (key<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> n <span class="symbol">=</span>
  categoricalFromCDF (cdfForCategorical logprobs) key
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="comment">-- batch variant to share the work of forming the cumsum
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- (alternatively we could rely on hoisting of loop constants)
</span></div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> categoricalBatch (logprobs<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) (key<span class="symbol">:</span> <span class="type-name">Key</span>) <span class="symbol">:</span> m<span class="symbol">=&gt;</span>n <span class="symbol">=</span>
  cdf <span class="symbol">=</span> cdfForCategorical logprobs
  <span class="keyword">for</span> i<span class="symbol">.</span> categoricalFromCDF cdf <span class="symbol">$</span> ixkey key i
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> logsumexp (x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> <span class="type-name">Float</span> <span class="symbol">=</span>
  m <span class="symbol">=</span> maximum x
  m <span class="symbol">+</span> (log <span class="symbol">$</span> sum <span class="keyword">for</span> i<span class="symbol">.</span> exp (x<span class="symbol">.</span>i <span class="symbol">-</span> m))
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> logsoftmax (x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  lse <span class="symbol">=</span> logsumexp x
  <span class="keyword">for</span> i<span class="symbol">.</span> x<span class="symbol">.</span>i <span class="symbol">-</span> lse
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> softmax (x<span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span>) <span class="symbol">:</span> n<span class="symbol">=&gt;</span><span class="type-name">Float</span> <span class="symbol">=</span>
  m <span class="symbol">=</span> maximum x
  e <span class="symbol">=</span>  <span class="keyword">for</span> i<span class="symbol">.</span> exp (x<span class="symbol">.</span>i <span class="symbol">-</span> m)
  s <span class="symbol">=</span> sum e
  <span class="keyword">for</span> i<span class="symbol">.</span> e<span class="symbol">.</span>i <span class="symbol">/</span> s
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Polynomials</h2>
<p>TODO: Move this somewhere else</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> evalpoly [<span class="type-name">VSpace</span> v] (coefficients<span class="command">:n</span><span class="symbol">=&gt;</span>v) (x<span class="symbol">:</span><span class="type-name">Float</span>) <span class="symbol">:</span> v <span class="symbol">=</span>
  <span class="comment">-- Evaluate a polynomial at x.  Same as Numpy&#39;s polyval.
</span>  fold zero <span class="symbol">\</span>i c<span class="symbol">.</span> coefficients<span class="symbol">.</span>i <span class="symbol">+</span> x <span class="symbol">.*</span> c
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>TestMode</h2>
<p>TODO: move this to be in Testing Helpers</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> dex_test_mode (()<span class="symbol">:</span><span class="type-name">Unit</span>) <span class="symbol">:</span> <span class="type-name">Bool</span> <span class="symbol">=</span> unsafeIO <span class="keyword">do</span> checkEnv &quot;<span class="type-name">DEX</span>_<span class="type-name">TEST</span>_<span class="type-name">MODE</span>&quot;
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="prose-block"><h2>Exception effect</h2>
<p>TODO: move <code>error</code> and <code>todo</code> to here.</p>
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> catch (f<span class="symbol">:</span><span class="type-name">Unit</span> <span class="symbol">-&gt;</span> {<span class="type-name">Except</span><span class="symbol">|</span>eff} a) <span class="symbol">:</span> {<span class="symbol">|</span>eff} <span class="type-name">Maybe</span> a <span class="symbol">=</span>
  ans <span class="symbol">=</span> %catchException f
  <span class="keyword">case</span> %sumToVariant ans <span class="keyword">of</span>
    {<span class="symbol">|</span>c<span class="symbol">=</span>()   <span class="symbol">|</span>} <span class="symbol">-&gt;</span> <span class="type-name">Nothing</span>
    {<span class="symbol">|</span>c<span class="symbol">|</span>c<span class="symbol">=</span>val<span class="symbol">|</span>} <span class="symbol">-&gt;</span> <span class="type-name">Just</span> val
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> throw (_<span class="symbol">:</span><span class="type-name">Unit</span>) <span class="symbol">:</span> {<span class="type-name">Except</span>} a <span class="symbol">=</span>
  %throwException a
</div></div><div class="cell"><div class="code-block">
</div></div><div class="cell"><div class="code-block"><span class="keyword">def</span> assert (b<span class="symbol">:</span><span class="type-name">Bool</span>) <span class="symbol">:</span> {<span class="type-name">Except</span>} <span class="type-name">Unit</span> <span class="symbol">=</span>
  <span class="keyword">if</span> not b <span class="keyword">then</span> throw ()
</div></div><div class="cell"><div class="code-block">

</div></div><div class="cell"><div class="prose-block"><h2>Testing Helpers</h2>
</div></div><div class="cell"><div class="code-block"><span class="comment">-- -- Reliably causes a segfault if pointers aren&#39;t initialized to zero.
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- -- TODO: add this test when we cache modules
</span></div></div><div class="cell"><div class="code-block"><span class="comment">-- justSomeDataToTestCaching = toList for i:(Fin 100).
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--   if ordinal i == 0
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--     then Left (toList [1,2,3])
</span></div></div><div class="cell"><div class="code-block"><span class="comment">--     else Right 1
</span></div></div></div></body></html>